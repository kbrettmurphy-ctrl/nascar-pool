<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <base target="_top">

  <!-- ‚úÖ Correct viewport (prevents iOS weird scaling + supports safe-area) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <title>NASCAR Pool 2026</title>

  <style>
    :root{
      --cardA: 0.78;
      --microA: 0.72;
      --cardBg: rgba(255,255,255,var(--cardA));
      --microBg: rgba(255,255,255,var(--microA));

      --stroke:#e5e7eb;
      --ink:#0f172a;

      --bg:#0b0b0b;
      --card:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.12);

      --nav:#000000;
      --nav2:#111827;

      /* -- NASCAR Color theme -- */
      --blue:#007AC2;
      --red:#E4002B;
      --yellow:#FFD659;
      --black:#000000;

      --btnPrimary: var(--red);
      --btnSecondary: var(--blue);
      --danger: var(--red);

      --pad:12px;
      --radius:16px;
      --radius2:14px;

      --h2:24px;
      --big:20px;
      --body:14px;

      --tight:10px;
      --micro:8px;
      --nano:6px;

      /* My Matchup tight mode */
      --mmPad:8px;
      --mmGap:6px;
      --mmHeaderGap:4px;

      /* iOS bottom bar fix vars */
      --vvb: 0px;    /* visual viewport bottom gap */
      --navH: 74px;  /* approximate bottom nav height */

      /* Overall name column width (computed in JS) */
      --nameW: 120px;
    }

    *{ box-sizing:border-box; }

    body {
      font-size: var(--body);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;
      padding: var(--pad);
      max-width: 700px;
      margin: 0 auto;
      background: var(--bg);
      color: var(--text);

      padding-bottom: calc(var(--navH) + env(safe-area-inset-bottom) + var(--vvb));
      position: relative;
      overflow-x: hidden;
    }

    h2 { margin: 0 0 6px 0; font-size: var(--h2); letter-spacing: -0.3px; }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,214,89,.14);
      border:1px solid rgba(255,214,89,.40);
      color: var(--yellow);
      font-size:12px;
      font-weight:700;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      margin: 12px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .topActions{
      display:flex;
      gap:10px;
      width:100%;
      margin: 10px 0 8px 0;
    }

    button{
      border: 1px solid var(--line);
      cursor:pointer;
      font-weight:800;
      border-radius: 25px;
      padding: 8px 8px;
      font-size: 14px;
    }
    button.primary{ background:#111; color:#fff; margin-top: 3px; }
    button.secondary{ background:#334155; color:#fff; }
    button.topactions{ background: rgba(228, 0, 43, .4); color: var(--text); border: 1px solid var(--line); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    label { display:block; font-size: 13px; margin: 10px 0 6px; color:rgba(255,255,255,.9); }
    select, input {
      width:100%;
      font-size: 16px;
      color: var(--text);
      padding: 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,122,194,.14);
    }

    .big { font-size: var(--big); font-weight: 900; letter-spacing:-0.2px; }
    .muted { color: var(--muted); font-size: 13px; }

    .status { margin-top: 10px; font-size: var(--body); white-space: pre-wrap; }
    #standingsArea{ white-space: normal; }

    /* ---- Current Race ---- */
    .raceHeaderRow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    #currentHeader{ font-size: var(--big); font-weight: 900; letter-spacing:-0.2px; }
    #currentSub{ font-size: 13px; color: var(--muted); }

    .matchupCard{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(0,122,194,.14);
      padding: var(--micro);
      margin: 8px 0;
    }

    .matchupRow{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items:center;
    }

    .side{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .side.right{ text-align:right; align-items:flex-end; }

    .pName{
      font-weight: 900;
      font-size: 17px;
      line-height: 1.1;
      margin: 0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pMeta{
      font-size: 14px;
      color: var(--yellow);
      line-height: 1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .vsBadge{
      font-weight: 900;
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 10px;
      background: #e5e7eb;
      color: #111;
      letter-spacing: 0.4px;
    }

    @media (max-width: 480px){
      .matchupRow{ grid-template-columns: 1fr; gap: 6px; text-align:center; }
      .side.right{ text-align:center; align-items:center; }
      .vsBadge{ margin: 2px auto; }
      .pMeta{ white-space:normal; }
    }

    .elimTitle{ margin-top: 10px; font-weight: 900; font-size: 18px; }
    .elimItem{ font-size: 14px; color: var(--muted); margin-top: 4px; }

    /* ---- Bracket ---- */
    .bracketGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      width: 100%;
    }
    .bracketCol{
      min-width: 0;
      border:1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      padding: 6px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .bracketHdr{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
    }
    .roundTag{
      display:inline-block;
      font-weight:900;
      font-size:10px;
      letter-spacing:.5px;
      padding:3px 7px;
      border-radius:999px;
      background: rgba(255,214,89,.14);
      border: 1px solid rgba(255,214,89,.14);
      color: var(--yellow);
      line-height:1;
    }
    .title{ display:flex; align-items:center; gap:6px; min-width:0; }
    .race{
      font-size:11px;
      color: var(--muted);
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .ticket{
      border:1px solid var(--line);
      border-radius: 12px;
      background:rgba(0,122,194,.14);
      color:#fff;
      overflow:hidden;
      margin: 4px 0;
    }
    .ticketRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      padding:5px 7px;
      min-width:0;
    }
    .ticketRow + .ticketRow{
      border-top:1px solid rgba(255,255,255,0.10);
    }
    .sideLeft{
      display:flex;
      align-items:center;
      gap:6px;
      flex: 1 1 auto;
      min-width:0;
      overflow:hidden;
      font-weight:900;
      font-size:11px;
      line-height:1.1;
    }
    .nameText{
      flex: 1 1 auto;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:block;
    }
    .seedBadge{
      flex: 0 0 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 18px;
      height: 16px;
      padding:0 5px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 10px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
    }
    .sideRight{
      display:flex;
      align-items:center;
      gap:6px;
      flex: 0 0 auto;
    }
    .winSlot{
      width: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .winDot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#16a34a;
      box-shadow: 0 0 0 2px rgba(22,163,74,0.18);
    }
    .avgBox{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      font-size:11px;
      padding:3px 7px;
      border-radius:10px;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.12);
      line-height:1;
    }
    .noAvg{
      font-weight:900;
      opacity:.7;
      font-size:11px;
      padding:3px 7px;
      line-height:1;
    }

    .bracketWrap{ position: relative; margin-top:10px; }

    /* ‚úÖ KEEP BRACKET STICKY OFF (mobile too) */
    .bracketSticky{ display:none !important; }

    .bracketFade{ display:none !important; }

    @media (max-width: 900px){
      .bracketGrid{
        grid-template-columns: repeat(4, 210px);
        gap: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 6px 10px 10px 10px;
        scroll-snap-type: x proximity;
      }
      .bracketCol{ scroll-snap-align: start; }
    }

    /* ---- My Matchup ---- */
    .mmWrap{ margin-top: 6px; }
    .mmHeader{
      font-weight: 900;
      font-size: 14px;
      margin: 0 0 var(--mmHeaderGap) 0;
      line-height: 1.2;
    }
    .microBox{
      border:1px solid var(--line);
      border-radius: 12px;
      padding: var(--mmPad);
      background: rgba(0,122,194,.14);
    }
    .youBox{
      border:2px solid #16a34a;
      background: rgba(0,122,194,.14);
    }
    .microTitle{
      font-weight: 900;
      font-size: 14px;
      margin: 0 0 2px 0;
      line-height: 1.15;
    }
    .microMeta{
      font-size: 14px;
      font-weight: 900;
      color: var(--yellow);
      margin: 0;
      line-height: 1.2;
    }
    .centerVS{
      text-align:center;
      font-weight:900;
      font-size: 12px;
      color: var(--red);
      margin: 6px 0;
      letter-spacing: .5px;
    }
    .deadBadge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 6px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      background: rgba(228,0,43,.85);
      color:#fff;
      opacity:.9;
    }
    .deadBadge .skull{ font-size:12px; line-height:1; }

    /* ---- Bottom Nav ---- */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
      z-index: 9999;
    }
    .navInner{
      max-width: 920px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    .navInner::before,
    .navInner::after{
      content:"";
      flex: 1 0 auto;
    }
    .navBtn{
      flex:0 0 auto;
      min-width: 98px;
      background: rgba(255,255,255,.06);
      color:#fff;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      text-align:center;
      white-space:nowrap;
    }
    .navBtn.active{
      background: rgba(0,122,194,.22);
      border-color: rgba(0,122,194,.55);
    }

    @media (max-width: 520px){
      :root{
        --pad: 16px;
        --h2: 30px;
        --big: 24px;
        --body: 17px;
        --radius: 18px;
        --radius2: 16px;
      }
      button{
        font-size: 14px;
        padding: 8px 8px;
        border-radius: 18px;
      }
      select, input{
        font-size: 17px;
        padding: 10px 12px;
        border-radius: 14px;
      }
      .pName{ font-size: 19px; }
      .pMeta{ font-size: 15px; }
      .navBtn{ font-size: 13px; }
      .card{ padding: 14px; }
    }

    /* Watermark background */
    :root{
      --wmOpacity: 0.42;
      --wmShift: 0px;
    }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background-image: url("nascar-logo.png");
      background-repeat: no-repeat;
      background-size: min(78vw, 700px);
      background-position: 50% calc(50% + var(--wmShift));
      opacity: var(--wmOpacity);
      pointer-events: none;
      z-index: 0;
    }
    body > *{
      position: relative;
      z-index: 1;
    }

    /* ---- Stats (UI) ---- */

    /* Mode buttons row */
    .statsModes{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: max-content;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 6px 0 4px;
      max-width: 100%;
    }
    .statsModes > button{
      white-space: nowrap;
      width: auto;
    }
    .statsModes::-webkit-scrollbar{ height:6px; }
    .statsModes::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.14);
      border-radius: 999px;
    }
    .statsModes button.secondary{
      padding:8px 12px;
      border-radius:12px;
      background: rgba(0,122,194,.22);
      flex: 0 0 auto;
      width:auto;
    }
    .statsModes button.secondary.active{
      background: rgba(0,122,194,.42);
      border: 1px solid rgba(0,122,194,.55);
    }

    .statsPanel{ margin-top: 8px; }
    .statsPanel .big{ margin: 6px 0 4px; }
    .statsPanel .muted{ margin: 0 0 8px; }

    /* ‚úÖ OVERALL: fixed rank col + fixed name col (based on longest name) + pills */
    .statsRow.overallRow{
      display: grid;
      grid-template-columns: 42px var(--nameW) 1fr;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,122,194,.10);
      margin-top: 6px;
      min-width: 0;
    }

    .rankBadge{
      min-width: 32px;
      height: 24px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:400;
      font-variant-numeric: tabular-nums;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      font-size: 14px;
    }

    .statsName{
      font-weight:400;
      color: var(--text);
      white-space: nowrap;
      overflow: visible;    /* show full name */
      text-align: left;     /* no centering */
      font-size: 14px;
      min-width: 0;
    }

    .statsBadges{
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
      justify-content: flex-start;
      min-width: 0;
    }
    .statsBadges::-webkit-scrollbar{ height:4px; }
    .statsBadges::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 999px;
    }

    .miniPill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-size:11px;
      font-weight:900;
      color: var(--text);
      font-variant-numeric: tabular-nums;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .miniPill .k{ color: var(--muted); font-weight:800; }

    /* Non-overall rows (simple 2-col layout) */
    .statsRow.simpleRow{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,122,194,.10);
      margin-top: 6px;
      min-width: 0;
    }

    .statsControls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top: 8px;
    }
    .statsControls label{ margin:0; }
    .statsControls select{
      width:auto;
      min-width: 220px;
      padding: 10px 12px;
    }

    .tiles{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top: 8px;
    }
    .tile{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,122,194,.10);
    }
    .tile .tLabel{ color: var(--muted); font-weight:800; font-size:12px; }
    .tile .tVal{ font-weight:900; font-size:22px; margin-top:4px; }

    @media (max-width: 520px){
      .tiles{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .statsControls select{ width:100%; }
    }
  </style>
</head>

<body>
  <h2>NASCAR Pool 2026</h2>

  <div class="sub">
    <span class="pill">Player Portal</span>
    <span id="welcomeName"></span>
  </div>

  <div class="topActions">
    <button class="topactions" onclick="clearSavedAndReset()">üßº Clear saved player</button>
    <button class="topactions" onclick="refreshActiveView()">üîÑ Refresh</button>
  </div>

  <!-- CURRENT RACE -->
  <div id="view-current" class="card" style="display:none;">
    <div class="raceHeaderRow">
      <div id="currentHeader">Current Race</div>
    </div>
    <div class="muted" id="currentSub"></div>
    <div id="matchupsArea" style="margin-top:10px;"></div>
    <div id="eliminatedArea" style="margin-top:12px;"></div>
  </div>

  <!-- MY MATCHUP -->
  <div id="view-mymatchup" class="card" style="display:none;">
    <div class="big">My Matchup</div>
    <div class="muted">Pick your name once. I might remember it.</div>

    <label>Your name</label>
    <select id="mmName"></select>

    <button class="primary" onclick="loadMyMatchup()">Show my matchup</button>
    <div id="mmStatus" class="mmWrap"></div>
  </div>

  <!-- STANDINGS -->
  <div id="view-standings" class="card" style="display:none;">
    <div class="big">Stats</div>
    <div class="muted">Pool standings & stats</div>
    <div id="standingsArea" class="status">Loading‚Ä¶</div>
  </div>

  <!-- DUES -->
  <div id="view-dues" class="card" style="display:none;">
    <div class="big">Dues</div>
    <div class="muted">Pick your name.</div>

    <label>Your name</label>
    <select id="duesName"></select>

    <button class="primary" onclick="loadDues()">Show my dues</button>
    <div class="status" id="duesStatus"></div>
  </div>

  <!-- BRACKET -->
  <div id="view-bracket" class="card" style="display:none;">
    <div class="big">Bracket</div>
    <div class="muted" id="bracketSub">Loading‚Ä¶</div>

    <div class="bracketWrap">
      <div id="bracketSticky" class="bracketSticky"></div>
      <div id="bracketArea">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottomNav">
    <div class="navInner">
      <button class="navBtn" id="nav-race" onclick="showView('current')">
        <div class="ico">üèÅ</div><div>Race</div>
      </button>
      <button class="navBtn" id="nav-bracket" onclick="showView('bracket')">
        <div class="ico">üèÜ</div><div>Bracket</div>
      </button>
      <button class="navBtn" id="nav-me" onclick="showView('mymatchup')">
        <div class="ico">üßç</div><div>Me</div>
      </button>
      <button class="navBtn" id="nav-stats" onclick="showView('standings')">
        <div class="ico">üìä</div><div>Stats</div>
      </button>
      <button class="navBtn" id="nav-dues" onclick="showView('dues')">
        <div class="ico">üí∞</div><div>Dues</div>
      </button>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG
     **********************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbw9ZWpslxculbHs3kwNWSBx9jU_QZx2PpLsWpa4N8DPK8qypXQObwfG5Vw_lh5lEizjuA/exec";
    const STORAGE_KEY = "nascar_pool_player_name";
    const VIEW_KEY = "nascar_pool_active_view";
    const roundLabel = (n) => (Number(n) === 4 ? "Championship" : `Round ${n}`);
    const views = ["current","mymatchup","standings","dues","bracket"];
    let activeView = "current";

    /**********************
     * iOS bottom bar fix
     **********************/
    (function fixIOSBottomBar(){
      function update(){
        const vv = window.visualViewport;
        if (!vv) return;
        const bottomGap = Math.max(0, window.innerHeight - (vv.height + vv.offsetTop));
        document.documentElement.style.setProperty("--vvb", bottomGap + "px");
      }
      update();
      window.addEventListener("resize", update);
      window.addEventListener("orientationchange", update);
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", update);
        window.visualViewport.addEventListener("scroll", update);
      }
    })();

    // Player site uses API_BASE directly.
    const ADMIN_KEY = "";

    async function apiCall(action, params = {}, isAdmin = false){
      const apiBase = API_BASE;
      const adminKey = ADMIN_KEY;
      if(!apiBase) throw new Error("Missing API Base URL.");
      if(isAdmin && !adminKey) throw new Error("Missing Admin Key.");

      const q = new URLSearchParams();
      q.set("action", action);
      if(isAdmin) q.set("key", adminKey);

      Object.keys(params || {}).forEach(k => {
        const v = params[k];
        if(v !== undefined && v !== null) q.set(k, v);
      });

      const url = apiBase + "?" + q.toString();
      return fetch(url, { cache: "no-store" }).then(r => r.json());
    }

    // ---------- Snapshot Loader ----------
    const SNAP_MAP = {
      context:   "./data/context.json",
      players:   "./data/players.json",
      matchups:  "./data/matchups.json",
      bracket:   "./data/bracket.json",
      standings: "./data/standings.json",
      dues:      "./data/dues.json",
      my:        "./data/myMatchups.json",
      h2h:       "./data/h2h.json",
      wins:      "./data/wins.json",
      drivers:   "./data/driverUsage.json",
    };

    async function fetchSnapshotJson(key, bustCache=false){
      const base = SNAP_MAP[key];
      if(!base) throw new Error("Unknown snapshot key: " + key);

      const url = bustCache
        ? base + (base.includes("?") ? "&" : "?") + "v=" + Date.now()
        : base;

      const res = await fetch(url, { cache: bustCache ? "no-store" : "default" });
      if(!res.ok) throw new Error(`Snapshot fetch failed (${res.status}) for ${key}`);
      return await res.json();
    }

    async function getData_(snapKey, action, params){
      try{
        return await fetchSnapshotJson(snapKey, false);
      }catch(e){
        const resp = await apiCall(action, params || {}, false);
        if(!resp || !resp.ok) throw new Error(resp?.error || ("API failed: " + action));
        return resp.data;
      }
    }

    /**********************
     * UI helpers
     **********************/
    function setActiveNav(which){
      const map = {
        current: "nav-race",
        mymatchup: "nav-me",
        standings: "nav-stats",
        dues: "nav-dues",
        bracket: "nav-bracket"
      };
      Object.values(map).forEach(id => {
        const b = document.getElementById(id);
        if (b) b.classList.remove("active");
      });
      const btn = document.getElementById(map[which]);
      if (btn) btn.classList.add("active");
    }

    function showView(which) {
      activeView = which;
      setActiveNav(which);
      localStorage.setItem(VIEW_KEY, which);

      views.forEach(v => {
        const el = document.getElementById("view-" + v);
        if (el) el.style.display = (v === which) ? "block" : "none";
      });

      if (which === "current") loadCurrent();
      if (which === "standings") loadStandings();
      if (which === "dues") loadDues();
      if (which === "mymatchup") loadMyMatchup();
      if (which === "bracket") loadBracket();
    }

    function refreshActiveView() {
      if (activeView === "current") loadCurrent();
      else if (activeView === "standings") loadStandings();
      else if (activeView === "dues") loadDues();
      else if (activeView === "mymatchup") loadMyMatchup();
      else if (activeView === "bracket") loadBracket();
    }

    function savePlayerName(name) {
      localStorage.setItem(STORAGE_KEY, String(name || ""));
      setWelcome();
    }

    function loadPlayerName() {
      return String(localStorage.getItem(STORAGE_KEY) || "").trim();
    }

    function hasPlayerName() {
      return !!loadPlayerName();
    }

    function clearSavedAndReset() {
      localStorage.removeItem(STORAGE_KEY);
      const mm = document.getElementById("mmName");
      const dd = document.getElementById("duesName");
      if (mm) mm.value = "";
      if (dd) dd.value = "";
      setWelcome();
      showView("current"); // ‚úÖ fixed (was showView(which) with undefined var)
    }

    function setWelcome() {
      const w = document.getElementById("welcomeName");
      const name = loadPlayerName();
      if (!w) return;
      w.textContent = name ? `Welcome back, ${name}` : "";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function escapeAttr(s) {
      return String(s ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function populatePlayerDropdowns(playerList) {
      const mm = document.getElementById("mmName");
      const dd = document.getElementById("duesName");

      const options = [`<option value="">Select your name‚Ä¶</option>`]
        .concat(playerList.map(n => `<option value="${escapeAttr(n)}">${escapeHtml(n)}</option>`))
        .join("");

      if (mm) mm.innerHTML = options;
      if (dd) dd.innerHTML = options;

      const saved = loadPlayerName();
      if (saved) {
        if (mm) mm.value = saved;
        if (dd) dd.value = saved;
      }

      if (mm) mm.onchange = () => {
        if (mm.value) {
          savePlayerName(mm.value);
          if (dd) dd.value = mm.value;
        }
      };

      if (dd) dd.onchange = () => {
        if (dd.value) {
          savePlayerName(dd.value);
          if (mm) mm.value = dd.value;
        }
      };
    }

    function formatDriversOrNumbers(driversArr, numsArr){
      const d1 = (driversArr && driversArr[0]) ? String(driversArr[0]).trim() : "";
      const d2 = (driversArr && driversArr[1]) ? String(driversArr[1]).trim() : "";
      if (d1 || d2) return [d1, d2].filter(Boolean).join(", ");

      const n1 = (numsArr && numsArr[0] != null && String(numsArr[0]).trim() !== "") ? String(numsArr[0]).trim() : "";
      const n2 = (numsArr && numsArr[1] != null && String(numsArr[1]).trim() !== "") ? String(numsArr[1]).trim() : "";
      if (n1 || n2) return `Numbers: ${[n1,n2].filter(Boolean).join(", ")}`;
      return "";
    }

    function resetStatPillScroll(scope){
      const root = scope || document;
      root.querySelectorAll('.statsBadges').forEach(el => {
        el.scrollLeft = 0;
        el.scrollTo(0, 0);
      });
    }
    function resetStatPillScrollSoon(scope){
      requestAnimationFrame(() => {
        requestAnimationFrame(() => resetStatPillScroll(scope));
      });
    }

    function syncOverallNameColumnWidth_(){
      const panel = document.getElementById("statsPanel");
      if(!panel) return;

      const names = panel.querySelectorAll(".statsRow.overallRow .statsName");
      if(!names.length) return;

      let max = 0;
      names.forEach(el => {
        max = Math.max(max, el.scrollWidth || 0);
      });

      max = Math.ceil(max + 8); // breathing room
      panel.style.setProperty("--nameW", max + "px");
    }

    window.addEventListener("resize", () => {
      if(_statsMode === "overall") {
        syncOverallNameColumnWidth_();
        resetStatPillScrollSoon(document.getElementById("statsPanel"));
      }
    });

    /**********************
     * Loaders
     **********************/
    async function loadPlayersThenInit() {
      try{
        const players = await getData_("players", "playerGetPlayerList");
        const safePlayers = Array.isArray(players) ? players : [];
        populatePlayerDropdowns(safePlayers);
        setWelcome();

        const last = String(localStorage.getItem(VIEW_KEY) || "").trim();
        const allowed = views.includes(last) ? last : "";
        if (allowed) showView(allowed);
        else if (hasPlayerName()) showView("mymatchup");
        else showView("current");
      }catch(e){
        setWelcome();
        showView("current");
      }
    }

    async function loadCurrent() {
      const header = document.getElementById("currentHeader");
      const sub = document.getElementById("currentSub");
      const area = document.getElementById("matchupsArea");
      const elim = document.getElementById("eliminatedArea");

      area.innerHTML = "Loading current race...";
      elim.innerHTML = "";

      try{
        const data = (await getData_("matchups", "playerGetCurrentRaceMatchups")) || {};

        header.textContent = data.race || "Current Race";
        const tour  = data.tournament ?? "";
        const round = data.currentRound ?? data.round ?? "";
        const roundText =
          round === "" ? "" :
          (Number(round) === 4 ? "Championship" : `Round ${round}`);

        sub.textContent = `Tournament ${tour}` + (roundText ? ` ¬∑ ${roundText}` : "");
        area.innerHTML = "";

        (data.matchups || []).forEach(m => {
          const card = document.createElement("div");
          card.className = "matchupCard";

          const leftMeta  = formatDriversOrNumbers(m.p1Drivers, m.p1Nums);
          const rightMeta = formatDriversOrNumbers(m.p2Drivers, m.p2Nums);

          card.innerHTML = `
            <div class="matchupRow">
              <div class="side left">
                <div class="pName">${escapeHtml(m.p1)}</div>
                ${leftMeta ? `<div class="pMeta">${escapeHtml(leftMeta)}</div>` : ``}
              </div>
              <div class="vsBadge">VS</div>
              <div class="side right">
                <div class="pName">${escapeHtml(m.p2)}</div>
                ${rightMeta ? `<div class="pMeta">${escapeHtml(rightMeta)}</div>` : ``}
              </div>
            </div>
          `;
          area.appendChild(card);
        });

        const eliminated = data.eliminated || [];
        if (eliminated.length > 0) {
          let html = `<div class="elimTitle">Eliminated</div>`;
          eliminated.forEach(p => {
            html += `<div class="elimItem">${escapeHtml(p)}</div>`;
          });
          elim.innerHTML = html;
        }
      }catch(e){
        area.innerHTML = "Error loading matchups.";
      }
    }

    async function loadMyMatchup() {
      const sel = document.getElementById("mmName");
      const out = document.getElementById("mmStatus");

      const name = sel ? String(sel.value || "").trim() : "";
      if (!name) { out.textContent = "Pick your name first."; return; }

      savePlayerName(name);
      out.textContent = "Loading‚Ä¶";

      try{
        let data = {};
        try{
          const all = await fetchSnapshotJson("my", false);
          data = (all && all[name]) ? all[name] : {};
        }catch(e){
          const res = await apiCall("playerGetMyMatchup", { name });
          if (!res || !res.ok) throw new Error(res?.error || "API failed");
          data = res.data || {};
        }

        if (data.status !== "active") {
          out.innerHTML = `
            <div class="microBox" style="margin-top:6px;">
              <div class="deadBadge" style="margin-bottom:8px;"><span class="skull">‚ò†Ô∏è</span> ELIMINATED</div>
              <div class="microMeta" style="color:rgba(255,255,255,.9)">
                ${escapeHtml(data.you || name)}, you're eliminated.
              </div>
            </div>
          `;
          return;
        }

        const youMeta = formatDriversOrNumbers(data.youDrivers, data.youNums);
        const oppMeta = formatDriversOrNumbers(data.oppDrivers, data.oppNums);

        out.innerHTML = `
          <div class="mmHeader">
            Tournament ${escapeHtml(data.tournament)} ¬∑ ${escapeHtml(data.race)} ¬∑ Round ${escapeHtml(data.round)}
          </div>

          <div class="microBox youBox">
            <div class="microTitle">YOU: ${escapeHtml(data.you)}</div>
            ${youMeta ? `<div class="microMeta">${escapeHtml(youMeta)}</div>` : ``}
          </div>

          <div class="centerVS">VS</div>

          <div class="microBox">
            <div class="microTitle">${escapeHtml(data.opponent)}</div>
            ${oppMeta ? `<div class="microMeta">${escapeHtml(oppMeta)}</div>` : ``}
          </div>
        `;
      }catch(e){
        out.textContent = "Error: " + (e && e.message ? e.message : e);
      }
    }

    async function loadDues() {
      const sel = document.getElementById("duesName");
      const out = document.getElementById("duesStatus");

      const name = sel ? String(sel.value || "").trim() : "";
      if (!name) { out.textContent = "Pick your name first."; return; }

      savePlayerName(name);
      out.textContent = "Loading‚Ä¶";

      try {
        const all = await getData_("dues", "playerGetDues", { name });

        let data = null;
        if (all && typeof all === "object" && !Array.isArray(all) && (all.name || all.paid != null || all.balance != null)) {
          data = all;
        } else if (all && typeof all === "object" && !Array.isArray(all) && all[name]) {
          data = all[name];
        } else if (Array.isArray(all)) {
          data = all.find(r => String(r?.name || "").trim().toLowerCase() === name.toLowerCase()) || null;
        } else if (all && Array.isArray(all.dues)) {
          data = all.dues.find(r => String(r?.name || "").trim().toLowerCase() === name.toLowerCase()) || null;
        }

        if (!data) throw new Error("No dues record found for " + name);

        const paid = Number(data.paid || 0);
        const balance = Number(data.balance || 0);
        const winnings = 180 - balance;

        out.textContent =
`${data.name || name}
Paid: $${paid.toFixed(2)}
Winnings: $${winnings.toFixed(2)}
Balance Due: $${balance.toFixed(2)}`;

        out.innerHTML = out.innerHTML.replace(
          /Balance Due: \$[0-9\.\-]+/,
          match => `<span style="color: var(--red); opacity: 0.9;">${match}</span>`
        );

      } catch (e) {
        out.textContent = "Error: " + (e && e.message ? e.message : e);
      }
    }

    // ---------- Stats / Standings ----------
    let _cache_standings = null;
    let _statsMode = "overall";

    async function loadStandings() {
      const area = document.getElementById("standingsArea");
      area.innerHTML = "Loading stats...";

      try{
        const data = await getData_("standings", "playerGetStandings");
        _cache_standings = data || {};

        area.innerHTML = `
          <div class="statsModes" id="statsModes">
            <button class="secondary" data-mode="overall">Overall</button>
            <button class="secondary" data-mode="tourney">Tourney Ranks</button>
            <button class="secondary" data-mode="h2h">H2H</button>
            <button class="secondary" data-mode="wins">Wins</button>
            <button class="secondary" data-mode="drivers">Driver Usage</button>
          </div>
          <div class="statsPanel" id="statsPanel"></div>
        `;

        const modes = area.querySelectorAll("#statsModes button");
        modes.forEach(b => {
          b.onclick = () => setStatsMode_(b.getAttribute("data-mode") || "overall");
        });

        setStatsMode_("overall");
      }catch(e){
        area.innerHTML = "Error: " + (e && e.message ? e.message : e);
      }
    }

    function setStatsMode_(mode){
      _statsMode = mode || "overall";
      const box = document.getElementById("statsPanel");
      const modes = document.querySelectorAll("#statsModes button");
      modes.forEach(b => b.classList.toggle("active", (b.getAttribute("data-mode") === _statsMode)));

      if (!box) return;
      if (_statsMode === "overall") return renderOverall_(box);
      if (_statsMode === "tourney") return renderTourney_(box);
      if (_statsMode === "h2h") return renderH2H_(box);
      if (_statsMode === "wins") return renderWins_(box);
      if (_statsMode === "drivers") return renderDrivers_(box);
      box.innerHTML = "";
    }

    function renderOverall_(box){
      const data = _cache_standings || {};
      const rows = Array.isArray(data.overall) ? data.overall : [];
      const headers = Array.isArray(data.overallHeaders) ? data.overallHeaders : [];

      if (!rows.length || !headers.length){
        box.innerHTML = `<div class="muted">(No standings data yet)</div>`;
        return;
      }

      const nameKey = headers.find(h => /name|player/i.test(h)) || headers[0];
      const rankKey = headers.find(h => /rank/i.test(h)) || headers[0];
      const badgeKeys = headers.filter(h => h !== nameKey && h !== rankKey).slice(0, 4);

      let html = `<div class="big">Overall</div>`;
      rows.forEach(r => {
        const rank = r[rankKey] ?? "";
        const name = r[nameKey] ?? "";
        const badges = badgeKeys.map(k => {
          const v = r[k];
          if (v == null || String(v).trim() === "") return "";
          return `<span class="miniPill"><span class="k">${escapeHtml(k)}:</span> ${escapeHtml(v)}</span>`;
        }).filter(Boolean).join("");

        html += `
          <div class="statsRow overallRow">
            <div class="rankBadge">${escapeHtml(rank || "‚Äî")}</div>
            <div class="statsName">${escapeHtml(name)}</div>
            <div class="statsBadges">${badges}</div>
          </div>
        `;
      });

      box.innerHTML = html;

      // ‚úÖ measure longest name then lock name column width, then reset pill scroll
      requestAnimationFrame(() => {
        syncOverallNameColumnWidth_();
        resetStatPillScrollSoon(box);
      });
    }

    function renderTourney_(box){
      const data = _cache_standings || {};
      const headers = Array.isArray(data.tournamentHeaders) ? data.tournamentHeaders : [];
      if (!headers.length){
        box.innerHTML = `<div class="muted">(No tournament rank data yet)</div>`;
        return;
      }

      const opts = headers.map(h => `<option value="${escapeAttr(h)}">${escapeHtml(h)}</option>`).join("");
      box.innerHTML = `
        <div class="big">Tournament Ranks</div>
        <div class="muted">Pick a tournament</div>
        <div class="statsControls">
          <select id="tourneyPick">${opts}</select>
        </div>
        <div id="tourneyRanksBox" style="margin-top:10px;"></div>
      `;

      const sel = document.getElementById("tourneyPick");
      const render = () => showTournamentRanks(sel.value);
      sel.onchange = render;
      render();
    }

    function showTournamentRanks(label) {
      const box = document.getElementById("tourneyRanksBox");
      const t = (_cache_standings && _cache_standings.tournaments) ? _cache_standings.tournaments : {};
      const listRaw = t[label] || [];

      let html = `<div style="margin-top:6px;font-weight:900;font-size:16px;">${escapeHtml(label)}</div>`;
      if (!Array.isArray(listRaw) || listRaw.length === 0) {
        html += `<div class="muted">(No data yet)</div>`;
        box.innerHTML = html;
        return;
      }

      const items = listRaw
        .map((it) => {
          if (it && typeof it === "object") {
            const player = it.player ?? it.name ?? it.Player ?? it.PLAYER ?? "";
            const rank = Number(it.rank ?? it.Rank ?? it.RANK);
            return { rank: Number.isFinite(rank) ? rank : null, player: String(player || "").trim() };
          }
          return { rank: null, player: String(it || "").trim() };
        })
        .filter(x => x.player);

      const hasRanks = items.some(x => Number.isFinite(x.rank));
      if (hasRanks) items.sort((a,b) => (a.rank ?? 999) - (b.rank ?? 999));

      let startRank = 17 - items.length;
      if (startRank < 1) startRank = 1;
      if (startRank > 16) startRank = 16;

      html += `<div>`;
      items.forEach((it, i) => {
        const r = Number.isFinite(it.rank) ? it.rank : (startRank + i);
        html += `
          <div class="statsRow simpleRow">
            <div class="statsName">${escapeHtml(r)}. ${escapeHtml(it.player)}</div>
          </div>
        `;
      });
      html += `</div>`;

      box.innerHTML = html;
    }

    async function renderH2H_(box){
      const you = loadPlayerName().trim();
      box.innerHTML = `
        <div class="big">Head-to-Head</div>
        <div class="muted">Pick a player</div>
        <div class="statsControls">
          <select id="h2hPick"></select>
        </div>
        <div id="h2hOut" style="margin-top:10px;">Loading‚Ä¶</div>
      `;

      const players = await getData_("players", "playerGetPlayerList");
      const sel = document.getElementById("h2hPick");
      sel.innerHTML = (players || []).map(p => `<option value="${escapeAttr(p)}">${escapeHtml(p)}</option>`).join("");
      if (you && (players || []).some(p => String(p).trim().toLowerCase() === you.toLowerCase())) sel.value = you;

      const out = document.getElementById("h2hOut");
      const load = async () => {
        out.textContent = "Loading‚Ä¶";
        try{
          const player = String(sel.value || "").trim();
          const res = await getData_("h2h", "playerGetH2H", { player });
          const rows = Array.isArray(res?.rows) ? res.rows : (Array.isArray(res?.[player]) ? res[player] : []);
          if (!rows.length){
            out.innerHTML = `<div class="muted">(No H2H data yet)</div>`;
            return;
          }
          let html = ``;
          rows.forEach(r => {
            const rec = r.record || ((r.wins!=null && r.losses!=null) ? `(${r.wins}-${r.losses})` : "");
            html += `
              <div class="statsRow simpleRow">
                <div class="statsName">vs ${escapeHtml(r.opponent || "")}</div>
                <div class="statsBadges">
                  <span class="miniPill">${escapeHtml(rec || "")}</span>
                </div>
              </div>
            `;
          });
          out.innerHTML = html;
          resetStatPillScrollSoon(out);
        }catch(e){
          out.innerHTML = `<div class="muted">H2H failed to load.</div>`;
        }
      };

      sel.onchange = load;
      load();
    }

    async function renderWins_(box){
      const you = loadPlayerName().trim();
      box.innerHTML = `
        <div class="big">Wins</div>
        <div class="muted">Race wins, bracket wins, and tourney wins</div>
        <div class="statsControls">
          <select id="winsPick"></select>
        </div>
        <div id="winsOut" style="margin-top:10px;">Loading‚Ä¶</div>
      `;

      const players = await getData_("players", "playerGetPlayerList");
      const sel = document.getElementById("winsPick");
      sel.innerHTML = (players || []).map(p => `<option value="${escapeAttr(p)}">${escapeHtml(p)}</option>`).join("");
      if (you && (players || []).some(p => String(p).trim().toLowerCase() === you.toLowerCase())) sel.value = you;

      const out = document.getElementById("winsOut");
      const load = async () => {
        out.textContent = "Loading‚Ä¶";
        try{
          const player = String(sel.value || "").trim();
          const res = await getData_("wins", "playerGetWinCounts", { player });
          const w = (res && (res.raceWins!=null || res.bracketWins!=null || res.tourneyWins!=null)) ? res : (res && res[player] ? res[player] : {});
          const raceWins = w?.raceWins ?? "‚Äî";
          const bracketWins = w?.bracketWins ?? "‚Äî";
          const tourneyWins = w?.tourneyWins ?? "‚Äî";
          out.innerHTML = `
            <div class="tiles">
              <div class="tile">
                <div class="tLabel">üèÅ Race Wins</div>
                <div class="tVal">${escapeHtml(raceWins)}</div>
              </div>
              <div class="tile">
                <div class="tLabel">üèÜ Bracket Wins</div>
                <div class="tVal">${escapeHtml(bracketWins)}</div>
              </div>
              <div class="tile">
                <div class="tLabel">üéØ Tourney Wins</div>
                <div class="tVal">${escapeHtml(tourneyWins)}</div>
              </div>
            </div>
          `;
        }catch(e){
          out.innerHTML = `<div class="muted">Wins failed to load.</div>`;
        }
      };
      sel.onchange = load;
      load();
    }

    async function renderDrivers_(box){
      const you = loadPlayerName().trim();
      box.innerHTML = `
        <div class="big">Driver Usage</div>
        <div class="muted">How many times a player has been assigned each driver</div>
        <div class="statsControls">
          <select id="drvPick"></select>
        </div>
        <div id="drvOut" style="margin-top:10px;">Loading‚Ä¶</div>
      `;

      const players = await getData_("players", "playerGetPlayerList");
      const sel = document.getElementById("drvPick");
      sel.innerHTML = (players || []).map(p => `<option value="${escapeAttr(p)}">${escapeHtml(p)}</option>`).join("");
      if (you && (players || []).some(p => String(p).trim().toLowerCase() === you.toLowerCase())) sel.value = you;

      const out = document.getElementById("drvOut");
      const load = async () => {
        out.textContent = "Loading‚Ä¶";
        try{
          const player = String(sel.value || "").trim();
          const res = await getData_("drivers", "playerGetDriverUsage", { player });
          const rows = Array.isArray(res?.rows) ? res.rows : (Array.isArray(res?.[player]) ? res[player] : []);
          if (!rows.length){
            out.innerHTML = `<div class="muted">(No driver usage data yet)</div>`;
            return;
          }

          let html = ``;
          rows.forEach(r => {
            html += `
              <div class="statsRow simpleRow">
                <div class="statsName">${escapeHtml(r.driver || "")}</div>
                <div class="statsBadges">
                  <span class="miniPill"><span class="k">Times:</span> ${escapeHtml(r.count ?? "")}</span>
                </div>
              </div>
            `;
          });
          out.innerHTML = html;
          resetStatPillScrollSoon(out);
        }catch(e){
          out.innerHTML = `<div class="muted">Driver usage failed to load.</div>`;
        }
      };
      sel.onchange = load;
      load();
    }

    async function loadBracket(){
      const sub = document.getElementById("bracketSub");
      const area = document.getElementById("bracketArea");

      sub.textContent = "Loading‚Ä¶";
      area.innerHTML = "Loading‚Ä¶";

      const fmtAvg = (n) => (n == null ? "" : Number(n).toFixed(1).replace(/\.0$/,""));

      try{
        const data = await getData_("bracket", "playerGetBracket");

        const tour  = data.tournament ?? "";
        const race  = data.currentRace ?? data.race ?? "";
        const round = data.currentRound ?? data.round ?? "";

        sub.textContent =
          `Tournament ${tour}` +
          (race ? ` ¬∑ ${race}` : "") +
          (round !== "" ? ` ¬∑ ${roundLabel(round)}` : "");

        const rounds = data.rounds || [];
        let html = `<div class="bracketGrid">`;

        rounds.forEach(r => {
          const tag = r.isCurrent
            ? `<span class="roundTag">CURRENT</span>`
            : `<span class="roundTag">${escapeHtml(roundLabel(r.round))}</span>`;

          const isFuture = !r.isCurrent && (r.round > data.currentRound);

          html += `
            <div class="bracketCol ${isFuture ? "isFuture" : ""}">
              <div class="bracketHdr">
                <div class="title">${tag}</div>
                <div class="race">${escapeHtml(r.raceLabel || "")}</div>
              </div>
          `;

          (r.matchups || []).forEach(m => {
            const p1Win = (m.winner && m.p1 && m.winner === m.p1);
            const p2Win = (m.winner && m.p2 && m.winner === m.p2);

            html += `
              <div class="ticket">
                <div class="ticketRow">
                  <div class="sideLeft">
                    <span class="seedBadge">${escapeHtml(m.s1 || "‚Äî")}</span>
                    <span class="nameText">${escapeHtml(m.p1 || "")}</span>
                  </div>
                  <div class="sideRight">
                    <span class="winSlot">${p1Win ? `<span class="winDot" title="Winner"></span>` : ``}</span>
                    ${m.a1 == null ? `<span class="noAvg">‚Äî</span>` : `<span class="avgBox">${escapeHtml(fmtAvg(m.a1))}</span>`}
                  </div>
                </div>

                <div class="ticketRow">
                  <div class="sideLeft">
                    <span class="seedBadge">${escapeHtml(m.s2 || "‚Äî")}</span>
                    <span class="nameText">${escapeHtml(m.p2 || "")}</span>
                  </div>
                  <div class="sideRight">
                    <span class="winSlot">${p2Win ? `<span class="winDot" title="Winner"></span>` : ``}</span>
                    ${m.a2 == null ? `<span class="noAvg">‚Äî</span>` : `<span class="avgBox">${escapeHtml(fmtAvg(m.a2))}</span>`}
                  </div>
                </div>
              </div>
            `;
          });

          html += `</div>`;
        });

        html += `</div>`;
        area.innerHTML = html;
      }catch(e){
        sub.textContent = "Bracket failed to load.";
        area.innerHTML = "Error: " + (e && e.message ? e.message : e);
      }
    }

    // Watermark parallax
    (function(){
      let ticking=false;
      function onScroll(){
        if(ticking) return;
        ticking=true;
        requestAnimationFrame(()=>{
          const y=window.scrollY||0;
          document.documentElement.style.setProperty('--wmShift', (y*0.08).toFixed(1)+'px');
          ticking=false;
        });
      }
      window.addEventListener('scroll', onScroll, {passive:true});
      window.addEventListener('resize', onScroll);
      onScroll();
    })();

    window.onload = () => { loadPlayersThenInit(); };
  </script>
</body>
</html>