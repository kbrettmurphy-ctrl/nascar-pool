<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>NASCAR Pool Admin</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --stroke:#e5e7eb;
      --muted:#6b7280;
      --ink:#0f172a;

      --vvb: 0px;
      --pad: 12px;
    }

    *{ box-sizing:border-box; }

    body {
      font-family: Arial, sans-serif;
      padding: var(--pad);
      max-width: 560px;
      margin: 0 auto;
      background: var(--bg);
      color: var(--ink);
      padding-bottom: calc(24px + env(safe-area-inset-bottom) + var(--vvb));
    }

    h2 { margin: 0 0 6px 0; }
    .sub { color:#666; font-size:12px; margin-bottom:12px; }
    .card { background:#fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 14px; margin: 12px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    label { display:block; font-size: 13px; margin: 10px 0 6px; color:#111; }
    select, button { width: 100%; font-size: 16px; padding: 12px; border-radius: 12px; }
    select { border: 1px solid #cbd5e1; background: #fff; }
    button { border: 0; margin-top: 10px; background: #111; color: #fff; font-weight: 700; cursor:pointer; }
    button.secondary { background: #334155; }
    button.warn { background: #7f1d1d; }
    button:disabled { opacity: 0.55; cursor:not-allowed; }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 240px; }

    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:700; }
    .status { margin-top: 10px; font-size: 14px; white-space: pre-wrap; }

    .keyRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .keyRow button{
      width:auto;
      margin-top:0;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
    }
    .keyHint{ font-size:12px; color:#64748b; }
  </style>
</head>

<body>
  <h2>NASCAR Pool Admin</h2>
  <div class="sub">
    <span id="currentPill" class="pill">Detecting current raceâ€¦</span>
    <div class="keyRow">
      <button class="secondary" onclick="setAdminKey()">ðŸ”‘ Set Admin Key</button>
      <button class="secondary" onclick="clearAdminKey()">ðŸ§¼ Clear Key</button>
      <span class="keyHint" id="keyHint"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label for="tournament">Tournament</label>
        <select id="tournament"></select>
      </div>
      <div>
        <label for="race">Race</label>
        <select id="race">
          <option value="">Select a tournament first</option>
        </select>
      </div>
    </div>

    <button class="secondary" id="refreshCtxBtn" onclick="detectCurrentContext()">ðŸ”„ Refresh Current Race</button>

    <button id="assignRaceBtn" onclick="assignNumbersRace()">Assign Numbers (Selected Race)</button>
    <button class="warn" id="assignAllBtn" onclick="assignNumbersAll()">Assign Numbers (ALL 4 Races)</button>

    <div id="status" class="status"></div>
  </div>

  <script>
    /**********************
     * CONFIG
     **********************/
    const API_BASE = "https://script.google.com/macros/s/AKfycbw9ZWpslxculbHs3kwNWSBx9jU_QZx2PpLsWpa4N8DPK8qypXQObwfG5Vw_lh5lEizjuA/exec"; // <-- same Apps Script /exec as index.html
    const ADMIN_KEY_STORAGE = "nascar_pool_admin_key";

    const statusEl = document.getElementById("status");
    const currentPill = document.getElementById("currentPill");
    const tSel = document.getElementById("tournament");
    const rSel = document.getElementById("race");
    const keyHint = document.getElementById("keyHint");

    const btns = [
      document.getElementById("refreshCtxBtn"),
      document.getElementById("assignRaceBtn"),
      document.getElementById("assignAllBtn"),
    ];

    /**********************
     * iOS visual viewport fix
     **********************/
    (function fixIOSBottomBar(){
      function update(){
        const vv = window.visualViewport;
        if (!vv) return;
        const bottomGap = Math.max(0, window.innerHeight - (vv.height + vv.offsetTop));
        document.documentElement.style.setProperty("--vvb", bottomGap + "px");
      }
      update();
      window.addEventListener("resize", update);
      window.addEventListener("orientationchange", update);
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", update);
        window.visualViewport.addEventListener("scroll", update);
      }
    })();

    /**********************
     * API helpers (Fetch + JSONP fallback)
     **********************/
    function apiUrl(params){
      const u = new URL(API_BASE);
      Object.keys(params).forEach(k => u.searchParams.set(k, params[k]));
      return u.toString();
    }

    function jsonp(url){
      return new Promise((resolve, reject) => {
        const cb = "__jsonp_cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 15000);

        function cleanup(){
          clearTimeout(timeout);
          delete window[cb];
          if (s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cb] = (data) => {
          cleanup();
          resolve(data);
        };

        const glue = (url.includes("?") ? "&" : "?");
        s.src = url + glue + "callback=" + encodeURIComponent(cb);
        s.onerror = () => {
          cleanup();
          reject(new Error("JSONP load failed"));
        };
        document.head.appendChild(s);
      });
    }

    async function apiCall(action, extraParams = {}){
      const key = getAdminKey();
      const url = apiUrl({ action, key, ...extraParams });

      try {
        const r = await fetch(url, { method: "GET", cache: "no-store" });
        const j = await r.json();
        return j;
      } catch (e) {
        return await jsonp(url);
      }
    }

    /**********************
     * Key handling
     **********************/
    function getAdminKey(){
      return String(localStorage.getItem(ADMIN_KEY_STORAGE) || "");
    }

    function setAdminKey(){
      const current = getAdminKey();
      const k = prompt("Enter Admin Key:", current || "");
      if (k == null) return;
      localStorage.setItem(ADMIN_KEY_STORAGE, String(k || "").trim());
      updateKeyHint();
    }

    function clearAdminKey(){
      localStorage.removeItem(ADMIN_KEY_STORAGE);
      updateKeyHint();
      setStatus("Admin key cleared.");
    }

    function updateKeyHint(){
      const k = getAdminKey();
      keyHint.textContent = k ? "Key: saved" : "Key: not set";
    }

    /**********************
     * UI helpers
     **********************/
    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setBusy(isBusy) { btns.forEach(b => b.disabled = !!isBusy); }

    function init() {
      updateKeyHint();

      for (let i = 1; i <= 9; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = "Tournament " + i;
        tSel.appendChild(opt);
      }

      detectCurrentContext();
      tSel.addEventListener("change", loadRaces);
    }

    async function detectCurrentContext() {
      setBusy(true);
      setStatus("Detecting current raceâ€¦");

      try{
        const res = await apiCall("adminGetCurrentContext");
        if (!res || !res.ok) throw new Error(res?.error || "API failed");

        const ctx = res.data || {};
        const label = (ctx && ctx.raceLabel) ? ctx.raceLabel : "(unknown)";
        currentPill.textContent = `Current: Tournament ${ctx.tournament} Â· ${label} Â· Round ${ctx.round}`;

        tSel.value = String(ctx.tournament || "1");

        await loadRaces();
        if (ctx.raceLabel) rSel.value = ctx.raceLabel;

        setStatus("");
      }catch(e){
        setStatus("Error: " + (e && e.message ? e.message : e));
        currentPill.textContent = "Current: (could not detect)";

        const msg = String(e && e.message ? e.message : e).toLowerCase();
        if (msg.includes("unauthorized") || msg.includes("admin key")) {
          setStatus("Admin API needs a key.\nTap ðŸ”‘ Set Admin Key, then try again.");
        }
      }finally{
        setBusy(false);
      }
    }

    async function loadRaces() {
      setStatus("Loading racesâ€¦");
      rSel.innerHTML = `<option value="">Select race...</option>`;

      try{
        const res = await apiCall("adminGetTournamentRaceHeaders", { tournament: tSel.value });
        if (!res || !res.ok) throw new Error(res?.error || "API failed");

        const headers = res.data || [];
        (headers || []).forEach(h => {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = h;
          rSel.appendChild(opt);
        });

        setStatus("");
      }catch(e){
        setStatus("Error: " + (e && e.message ? e.message : e));
      }
    }

    async function assignNumbersRace() {
      const race = rSel.value;
      if (!race) return setStatus("Pick a race first.");

      setBusy(true);
      setStatus("Assigning numbers (selected race)â€¦");

      try{
        const res = await apiCall("adminAssignNumbersForRace", { tournament: tSel.value, race });
        if (!res || !res.ok) throw new Error(res?.error || "API failed");

        const payload = res.data || {};
        setStatus(payload.message || "Done.");
      }catch(e){
        setStatus("Error: " + (e && e.message ? e.message : e));
      }finally{
        setBusy(false);
      }
    }

    async function assignNumbersAll() {
      const t = tSel.value;
      const ok = confirm(`Assign ALL four race number blocks for Tournament ${t}?\n\nThis overwrites F/J/N/R number ranges.`);
      if (!ok) return;

      setBusy(true);
      setStatus("Assigning numbers for ALL racesâ€¦");

      try{
        const res = await apiCall("adminAssignNumbersAllRaces", { tournament: t });
        if (!res || !res.ok) throw new Error(res?.error || "API failed");

        const payload = res.data || {};
        setStatus(payload.message || "Done.");
      }catch(e){
        setStatus("Error: " + (e && e.message ? e.message : e));
      }finally{
        setBusy(false);
      }
    }

    init();
  </script>
</body>
</html>
