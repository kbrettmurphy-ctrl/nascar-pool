<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />

    <!-- ‚úÖ Correct viewport (prevents iOS weird scaling + supports safe-area) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  
  <title>NASCAR Pool Admin</title>

  <style>
    :root{
      --bg:#020b12;0
      --card:#111111;
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --line:rgba(255,255,255,.12);

      --nav:#000000;

      --blue:#007AC2;     /* Lochmara */
      --red:#E4002B;      /* Monza */
      --yellow:#FFD659;   /* Mustard */
      --black:#000000;

      --btnPrimary: var(--red);
      --btnSecondary: var(--blue);
      --danger: var(--red);

      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    body::before{content:'';position:fixed;inset:0;background:url('nascar-logo.png') center/ min(78vw,700px) no-repeat;opacity:0.12;pointer-events:none;transform:translate3d(0,var(--wmY,0px),0);z-index:0;filter:none;mix-blend-mode:normal;}
    body{position:relative;}
    body>*{position:relative;z-index:1;}

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 120px;
    }
    .title{
      font-size: 34px;
      font-weight: 900;
      letter-spacing: -0.5px;
      margin: 6px 0 10px;
    }
    .pill{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,214,89,.14);
      border:1px solid rgba(255,214,89,.40);
      color: var(--yellow);
      font-weight: 900;
      font-size: 14px;
    }
    .pill.smallgo,
    .pill.smallstop{
      border: none;
      width: 64px;                 /* fixed, identical width */
      justify-content: center;     /* center text inside */
      font-size: 10px;
      font-weight: 800;
      color: rgba(255,255,255,.88);
      padding:8px 8px;
    }

    .pill.smallgo{
      background: rgba(77, 210, 29, .2);
    }

    .pill.smallstop{
      background: rgba(228, 0, 43, .2);
    }


    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h3{
      margin:0 0 10px;
      font-size: 18px;
      font-weight: 900;
    }
    .muted{color:var(--muted); font-size: 13px;}

    label{
      display:block;
      font-weight: 800;
      margin: 10px 0 6px;
      font-size: 13px;
      color: rgba(255,255,255,.9);
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      outline:none;
      font-size: 16px;
      background: rgba(0,0,0,.45);
      color: var(--text);
    }
    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.45)}
    textarea{min-height:120px; resize: vertical;}

    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding: 13px 14px;
      border-radius: 14px;
      border:none;
      cursor:pointer;
      font-weight: 900;
      font-size: 16px;
      background: var(--btnPrimary);
      color:#fff;
    }
    .btn.secondary{background: var(--btnSecondary);}
    .btn.danger{background: var(--danger);}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .spacer{height:8px}

    .msg{
      margin-top:10px;
      font-size: 13px;
      color: var(--text);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius: 14px;
      white-space: pre-wrap;
    }
    .err{border-color: rgba(228,0,43,.55); background: rgba(228,0,43,.10); }
    .ok{border-color: rgba(255,214,89,.55); background: rgba(255,214,89,.10); }

    .hide{display:none !important;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Bottom Nav */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(2,11,18,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,.10);
      z-index: 9999;
    }
    .navInner{
      max-width: 920px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }

    .navInner::before,
    .navInner::after{
      content:"";
      flex: 1 0 auto;
    }
    .navBtn{
      flex:0 0 auto;
      min-width: 98px;
      background: rgba(255,255,255,.06);
      color:#fff;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      text-align:center;
      white-space:nowrap;
    }
    .navBtn.active{
      background: rgba(0,122,194,.22);
      border-color: rgba(0,122,194,.55);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">NASCAR Pool Admin</div>

    <div class="pill" id="ctxPill">Current: <small>(loading‚Ä¶)</small></div>

    <!-- API CONFIG (hidden when configured; can be opened from ‚öôÔ∏è) -->
    <div class="grid" style="margin-top:12px;">
      <div id="apiConfigWrap" class="card">
        <h3>API Config</h3>
        <div class="muted">Saved locally on this device. If you switch browsers/devices, you‚Äôll re-enter it.</div>

        <div id="configSummary" class="hide" style="margin-top:10px;">
          <div class="msg ok">
            Configured ‚úÖ
            <div style="margin-top:6px;">
              API Base: <span class="mono" id="apiBaseMasked"></span><br/>
              Admin Key: <span class="mono" id="adminKeyMasked"></span>
            </div>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn secondary" onclick="editConfig()">Edit</button>
            <button class="btn danger" onclick="clearConfig()">Clear</button>
          </div>
        </div>

        <div id="configInputs" style="margin-top:10px;">
          <label>API Base (GAS /exec)</label>
          <input id="apiBase" placeholder="https://script.google.com/macros/s/.../exec" />

          <label>Admin Key</label>
          <input id="adminKey" placeholder="ADMIN_KEY" />

          <div class="spacer"></div>
          <button class="btn secondary" onclick="saveConfig()">Save Config</button>
          <div id="configMsg" class="msg hide"></div>
        </div>
      </div>
    </div>

    <!-- Panels -->
    <div class="grid" style="margin-top:14px;">

      <div class="card panel" id="panelNumbers">
        <h3>Assign Numbers</h3>
        <div class="muted">Defaults to the current race detected at the top.</div>

        <label>Tournament</label>
        <select id="numTourneySel">
          <option value="1">Tournament 1</option><option value="2">Tournament 2</option><option value="3">Tournament 3</option>
          <option value="4">Tournament 4</option><option value="5">Tournament 5</option><option value="6">Tournament 6</option>
          <option value="7">Tournament 7</option><option value="8">Tournament 8</option><option value="9">Tournament 9</option>
        </select>

        <label>Race</label>
        <select id="numRaceSel"><option value="">(loading‚Ä¶)</option></select>

        <div class="spacer"></div>
        <button class="btn" onclick="assignNumbersSelectedFromPanel()">Assign Numbers (Selected Race)</button>

        <div class="spacer"></div>
        <button class="btn secondary" onclick="assignNumbersAllFromPanel()">Assign Numbers (ALL 4 Races)</button>

        <div id="numMsg" class="msg hide"></div>
      </div>

      <div class="card panel hide" id="panelImport">
        <h3>Paste Starting Lineups / Finishes</h3>
        <div class="muted">Paste the Wikipedia table block. We‚Äôll strip junk like ‚Äú(R)‚Äù and ‚Äú(i)‚Äù and try to match your Drivers tab.</div>

        <label>Which sheet?</label>
        <select id="sheetTypeSel" onchange="loadRaceHeadersForSheet()">
          <option>Starting Lineups</option>
          <option>Finishes</option>
        </select>

        <label>Race Header</label>
        <select id="raceHeaderSel"><option value="">(loading‚Ä¶)</option></select>

        <label>Paste the table block</label>
        <textarea id="rawPaste" placeholder="Paste from Wikipedia (or wherever) here‚Ä¶"></textarea>

        <div class="spacer"></div>
        <button class="btn" onclick="importPaste()">Import Paste</button>
        
        <label style="margin-top:12px;">NASCAR Auto Import</label>
        <div class="row">
          <button class="btn secondary" onclick="importNascarQualifying()">Import Lineups</button>
          <button class="btn secondary" onclick="importNascarResults()">Import Finishes</button>
        </div>

        <label style="margin-top:10px; display:flex; gap:10px; align-items:center; font-weight:800;">
          <input type="checkbox" id="autoPublishAfterImport" checked style="width:auto; transform:scale(1.1);">
          Auto-publish after import
        </label>

        <div id="importMsg" class="msg hide"></div>
      </div>

      <div class="card panel hide" id="panelRanks">
        <h3>Refresh Overall Rankings</h3>
        <div class="muted">Runs <span class="mono">compileOverallRanks()</span> so the Stats page updates.</div>

        <div class="spacer"></div>
        <button class="btn" onclick="runCompileOverallRanks()">Run CompileOverallRanks</button>

        <div id="ranksMsg" class="msg hide"></div>
        <div class="spacer"></div> <!--added to move to this page -->
        <button class="btn secondary" onclick="showH2HPicker()">Compile H2H Records</button> <!--added to move to this page -->
        <!-- <button class="primary" onclick="showH2HPicker()">Compile H2H Records</button> -->

        <div id="h2hPicker" style="display:none; margin-top:8px;">
          
          <select id="h2hScope" style="width:100%; margin-bottom:8px;">
            <option value="ALL">ALL tournaments (1‚Äì9)</option>
            <option value="UPTO:1">Up to Tournament 1</option>
            <option value="UPTO:2">Up to Tournament 2</option>
            <option value="UPTO:3">Up to Tournament 3</option>
            <option value="UPTO:4">Up to Tournament 4</option>
            <option value="UPTO:5">Up to Tournament 5</option>
            <option value="UPTO:6">Up to Tournament 6</option>
            <option value="UPTO:7">Up to Tournament 7</option>
            <option value="UPTO:8">Up to Tournament 8</option>
            <option value="UPTO:9">Up to Tournament 9</option>
          </select>

          <div style="display:flex; gap:8px;">
            <button class="pill smallgo" onclick="compileH2HFromPicker()">Go</button>
            <button class="pill smallstop" onclick="hideH2HPicker()">Cancel</button>
          </div>
        </div>

        <!-- <div class="spacer"></div> <!--added to move to this page -->
        <div id="h2hMsg" class="msg hide"></div>
      </div>

      <div class="card panel hide" id="panelWinnings">
        <h3>Tournament Winnings</h3>
        <!-- <label>Tournament</label> -->
        <select id="winTourneySel">
          <option value="1">Tournament 1</option><option value="2">Tournament 2</option><option value="3">Tournament 3</option>
          <option value="4">Tournament 4</option><option value="5">Tournament 5</option><option value="6">Tournament 6</option>
          <option value="7">Tournament 7</option><option value="8">Tournament 8</option><option value="9">Tournament 9</option>
        </select>

        <div class="spacer"></div>
        <button class="btn secondary" onclick="showWinnings()">Show Winnings</button>

        <div id="winningsMsg" class="msg hide"></div>
      </div>

      <div class="card panel hide" id="panelFunds">
        <h3>Add Funds</h3>
        <label>Player</label>
        <select id="playerSel"><option value="">(loading‚Ä¶)</option></select>

        <label>Amount</label>
        <input id="fundsAmt" placeholder="25 or 25.00" />

        <div class="spacer"></div>
        <button class="btn" onclick="addFunds()">Add Funds</button>

        <div id="fundsMsg" class="msg hide"></div>
      </div>

      <div class="card panel hide" id="panelPublish">
        <h3>Publish to GitHub (Static Snapshot)</h3>
        <div class="muted">
          This pushes fresh JSON files into <span class="mono">/data</span> in your repo so the player site loads fast.
          After you assign numbers, import finishes, or update stats‚Ä¶ hit this once.
        </div>

        <!-- <div class="spacer"></div> -->
        <!-- <button class="btn secondary" onclick="compileH2H()">ü§ù Compile H2H Records</button> -->
        <div class="spacer"></div>
        <button class="btn" onclick="publishSnapshot()">üöÄ Publish Snapshot</button>

        <div id="pubMsg" class="msg hide"></div>

        <div class="spacer"></div>
        <div class="muted">
          Required once in GAS Script Properties:<br/>
          <span class="mono">GITHUB_TOKEN</span>, <span class="mono">GITHUB_OWNER</span>, <span class="mono">GITHUB_REPO</span>, (optional) <span class="mono">GITHUB_BRANCH</span>
        </div>
        <div class="spacer"></div>
        <button class="btn danger" onclick="resetSeason()">üß® Reset Season</button>
        <div id="resetMsg" class="msg hide"></div>
      </div>

    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottomNav">
    <div class="navInner">
      <button class="navBtn avtive" onclick="showPanel('Numbers', this)">üé≤<span>Numbers</span></button>
      <button class="navBtn" onclick="showPanel('Import', this)">üìã<span>Lineups</span></button>
      <button class="navBtn" onclick="showPanel('Ranks', this)">üìä<span>Stats</span></button>
      <button class="navBtn" onclick="showPanel('Winnings', this)">üèÜ<span>Winnings</span></button>
      <button class="navBtn" onclick="showPanel('Funds', this)">üíµ<span>Add</span></button>
      <button class="navBtn" onclick="showPanel('Publish', this)">üöÄ<span>Publish</span></button>
      <button class="navBtn" onclick="toggleConfigCard()">‚öôÔ∏è<span>Config</span></button>
    </div>
  </div>

<script>
  // ---------- Storage ----------
  const LS_API = "nascar_api_base";
  const LS_KEY = "nascar_admin_key";
  const LS_ADMIN_PANEL = "nascar_admin_active_panel";

  function getCfg(){
    return {
      apiBase: (localStorage.getItem(LS_API) || "").trim(),
      adminKey: (localStorage.getItem(LS_KEY) || "").trim(),
    };
  }
  function mask(s){
    if(!s) return "(empty)";
    if(s.length <= 10) return "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
    return s.slice(0, 12) + "‚Ä¶";
  }

  // ---------- Config UI ----------
  function syncConfigUI(){
    const {apiBase, adminKey} = getCfg();
    const has = !!apiBase && !!adminKey;

    document.getElementById("configSummary").classList.toggle("hide", !has);
    document.getElementById("configInputs").classList.toggle("hide", has);

    if(has){
      document.getElementById("apiBaseMasked").textContent = mask(apiBase);
      document.getElementById("adminKeyMasked").textContent = mask(adminKey);
    }else{
      document.getElementById("apiBase").value = apiBase || "";
      document.getElementById("adminKey").value = adminKey || "";
    }
  }

  function hasAdminConfig(){
    const {apiBase, adminKey} = getCfg();
    return !!apiBase && !!adminKey;
  }

  // When configured we hide the big card (but Config button can still open it)
  function applyConfigVisibility(forceShow=false){
    const wrap = document.getElementById("apiConfigWrap");
    if(!wrap) return;

    if(forceShow){
      wrap.classList.remove("hide");
      return;
    }
    if(hasAdminConfig()){
      wrap.classList.add("hide");
    }else{
      wrap.classList.remove("hide");
    }
  }

  function toggleConfigCard(){
    const wrap = document.getElementById("apiConfigWrap");
    if(!wrap) return;

    const isHidden = wrap.classList.contains("hide");
    if(isHidden){
      wrap.classList.remove("hide");
      // also make sure inputs/summary reflect saved state
      syncConfigUI();
    }else{
      // if not configured, don't allow hiding (you need to see it)
      if(!hasAdminConfig()) return;
      wrap.classList.add("hide");
    }
  }

  function saveConfig(){
    const apiBase = document.getElementById("apiBase").value.trim();
    const adminKey = document.getElementById("adminKey").value.trim();
    const msg = document.getElementById("configMsg");

    if(!apiBase || !apiBase.includes("/exec")){
      showMsg(msg, "Error: API Base must be your GAS Web App URL ending in /exec", true);
      return;
    }
    if(!adminKey){
      showMsg(msg, "Error: Admin Key required.", true);
      return;
    }

    localStorage.setItem(LS_API, apiBase);
    localStorage.setItem(LS_KEY, adminKey);

    showMsg(msg, "Saved ‚úÖ", false);
    syncConfigUI();
    applyConfigVisibility(false);
    bootstrap();
  }

  function editConfig(){
    // Show the card + inputs but KEEP the saved values (don‚Äôt nuke localStorage)
    applyConfigVisibility(true);
    const {apiBase, adminKey} = getCfg();
    document.getElementById("configSummary").classList.add("hide");
    document.getElementById("configInputs").classList.remove("hide");
    document.getElementById("apiBase").value = apiBase || "";
    document.getElementById("adminKey").value = adminKey || "";
  }

  function clearConfig(){
    localStorage.removeItem(LS_API);
    localStorage.removeItem(LS_KEY);
    syncConfigUI();
    document.getElementById("ctxPill").innerHTML = `Current: <small>(not configured)</small>`;
    applyConfigVisibility(false);
  }

  // ---------- UI helpers ----------
  function showMsg(el, text, isErr){
    el.classList.remove("hide","err","ok");
    el.classList.add(isErr ? "err" : "ok");
    el.textContent = text;
  }
  function hideMsg(el){ el.classList.add("hide"); }

  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function showPanel(name, btn){
    // hide all panels
    document.querySelectorAll(".panel").forEach(p => p.classList.add("hide"));
    const panel = document.getElementById("panel"+name);
    if(panel) panel.classList.remove("hide");

    // nav active state
    document.querySelectorAll(".navBtn").forEach(b => b.classList.remove("active"));

    // If caller passed the button, use it. Otherwise find the matching one.
    let activeBtn = btn;
    if(!activeBtn){
      activeBtn = Array.from(document.querySelectorAll(".navBtn"))
        .find(b => (b.getAttribute("onclick") || "").includes(`showPanel('${name}'`));
    }
  if(activeBtn) activeBtn.classList.add("active");

  // ‚úÖ persist
  try{ localStorage.setItem(LS_ADMIN_PANEL, String(name || "")); }catch(e){}
}


  // ---------- API ----------
  async function apiCall(action, params={}, isAdmin=true){
    const {apiBase, adminKey} = getCfg();
    if(!apiBase) throw new Error("Missing API Base URL.");
    if(isAdmin && !adminKey) throw new Error("Missing Admin Key.");

    const q = new URLSearchParams();
    q.set("action", action);
    if(isAdmin) q.set("key", adminKey);
    Object.keys(params || {}).forEach(k => {
      const v = params[k];
      if (v === undefined || v === null) return;   // ‚úÖ don't send garbage
      q.set(k, String(v));
    });

    const url = apiBase + "?" + q.toString();
    const res = await fetch(url, { cache: "no-store" });
    const json = await res.json();
    return json;
  }

  // ---------- Data loaders ----------
  async function refreshContext(){
    const pill = document.getElementById("ctxPill");
    try{
      pill.innerHTML = `Current: <small>(loading‚Ä¶)</small>`;
      const r = await apiCall("adminGetCurrentContext", {}, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      const c = r.data || {};

      window.__ctx = { tournament: String(c.tournament||""), raceLabel: String(c.raceLabel||"") };

      pill.innerHTML = `Current: <small>T${c.tournament} ¬∑ Round ${c.round} ¬∑ ${escapeHtml(c.raceLabel || "(no label)")}</small>`;

      try { await syncNumbersPanelDefaults(); } catch(e) {}
    } catch(e){
      let reason = (e && e.message) ? e.message : String(e || "Unknown error");

      if (reason.includes("Failed to fetch")) {
        reason = "Network blocked or API URL unreachable";
      }

      pill.innerHTML = `Current: <small style="color:#E4002B;">(error: ${escapeHtml(reason)})</small>`;
      window.__ctx = null;
    }
  }

  async function loadPlayers(){
    const sel = document.getElementById("playerSel");
    sel.innerHTML = `<option value="">(loading‚Ä¶)</option>`;
    try{
      const r = await apiCall("playerGetPlayerList", {}, false);
      if(!r.ok) throw new Error(r.error || "API failed");
      const list = r.data || [];
      sel.innerHTML = `<option value="">Select‚Ä¶</option>` + list.map(x => `<option>${escapeHtml(x)}</option>`).join("");
    }catch(e){
      sel.innerHTML = `<option value="">(error)</option>`;
    }
  }

  async function loadRaceHeadersForSheet(){
    const sheetType = document.getElementById("sheetTypeSel").value;
    const sel = document.getElementById("raceHeaderSel");
    sel.innerHTML = `<option value="">(loading‚Ä¶)</option>`;
    try{
      const r = await apiCall("adminGetRaceHeaders", { sheetType }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      const headers = r.data || [];
      if(!headers.length){
        sel.innerHTML = `<option value="">(none)</option>`;
        return;
      }
      sel.innerHTML =
        `<option value="">Select‚Ä¶</option>` +
        headers.map(h => `<option>${escapeHtml(h)}</option>`).join("");
      // üî• Auto-select current race if it exists
      const ctxLabel = window.__ctx?.raceLabel || "";
      if(ctxLabel && headers.includes(ctxLabel)){
        sel.value = ctxLabel;
      }
    }catch(e){
      sel.innerHTML = `<option value="">(error)</option>`;
    }
  }

  async function loadRaceHeadersForTournamentInto(selectEl, tournament){
    selectEl.innerHTML = `<option value="">(loading‚Ä¶)</option>`;
    try{
      const r = await apiCall("adminGetTournamentRaceHeaders", { tournament }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      const headers = r.data || [];
      selectEl.innerHTML = headers.length
        ? `<option value="">Select‚Ä¶</option>` + headers.map(h => `<option>${escapeHtml(h)}</option>`).join("")
        : `<option value="">(none)</option>`;
      return headers;
    }catch(e){
      selectEl.innerHTML = `<option value="">(error)</option>`;
      return [];
    }
  }

  async function syncNumbersPanelDefaults(){
    const ctx = window.__ctx;
    const tSel = document.getElementById("numTourneySel");
    const rSel = document.getElementById("numRaceSel");
    if(!tSel || !rSel) return;

    const t = ctx?.tournament || "1";
    tSel.value = t;

    const headers = await loadRaceHeadersForTournamentInto(rSel, t);
    const want = ctx?.raceLabel || "";
    if(want && headers.includes(want)) rSel.value = want;
  }

  // Tournament changed inside Numbers panel
  document.getElementById("numTourneySel").addEventListener("change", async () => {
    const t = document.getElementById("numTourneySel").value;
    const rSel = document.getElementById("numRaceSel");
    await loadRaceHeadersForTournamentInto(rSel, t);
  });

  // ---------- Actions ----------
  async function assignNumbersSelectedFromPanel(){
    const msg = document.getElementById("numMsg");
    hideMsg(msg);

    const t = document.getElementById("numTourneySel").value;
    const race = document.getElementById("numRaceSel").value;
    if(!race){ showMsg(msg, "Pick a race first.", true); return; }

    try{
      showMsg(msg, "Working‚Ä¶", false);
      const r = await apiCall("adminAssignNumbersForRace", { tournament: t, race }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.message || "Done.", false);
      refreshContext();
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function assignNumbersAllFromPanel(){
    const msg = document.getElementById("numMsg");
    hideMsg(msg);

    const t = document.getElementById("numTourneySel").value;

    try{
      showMsg(msg, "Working‚Ä¶", false);
      const r = await apiCall("adminAssignNumbersAllRaces", { tournament: t }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.message || "Done.", false);
      refreshContext();
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function addFunds(){
    const msg = document.getElementById("fundsMsg");
    hideMsg(msg);

    const player = document.getElementById("playerSel").value;
    const amt = document.getElementById("fundsAmt").value.trim();
    if(!player){ showMsg(msg, "Pick a player.", true); return; }
    if(!amt){ showMsg(msg, "Enter an amount.", true); return; }

    try{
      showMsg(msg, "Working‚Ä¶", false);
      const r = await apiCall("adminAddFunds", { player, amount: amt }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.message || "Saved.", false);
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function importPaste(){
  const msg = document.getElementById("importMsg");
  hideMsg(msg);

  const sheetType = document.getElementById("sheetTypeSel").value;
  const header    = document.getElementById("raceHeaderSel").value;
  const rawText   = document.getElementById("rawPaste").value;

  if(!header){ showMsg(msg, "Pick a race header.", true); return; }
  if(!rawText.trim()){ showMsg(msg, "Paste the table block first.", true); return; }

  const st = String(sheetType || "").toLowerCase();
  const isFinishes = st.includes("finish");
  const isLineups  = st.includes("starting") || st.includes("lineup");

  try{
    showMsg(msg, "Importing‚Ä¶", false);
    await new Promise(requestAnimationFrame);

    const r = await apiCall("adminImportPastedList", { sheetType, header, rawText }, true);
    if(!r.ok) throw new Error(r.error || "API failed");

    const rowsWritten = r?.data?.rowsWritten ?? "?";

    if(isFinishes){
      showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows). Updating stats‚Ä¶`, false);
      await new Promise(requestAnimationFrame);

      const r1 = await apiCall("adminCompileOverallRanks", {}, true);
      if(!r1.ok) throw new Error(r1.error || "Ranks update failed");

      showMsg(msg, "Ranks updated. Updating H2H‚Ä¶", false);
      await new Promise(requestAnimationFrame);

      const r2 = await apiCall("adminCompileHeadToHead", { scope: "ALL" }, true);
      if(!r2.ok) throw new Error(r2.error || "H2H update failed");

      showMsg(msg, "H2H updated. Publishing JSON‚Ä¶", false);
      await new Promise(requestAnimationFrame);

      const r3 = await apiCall("adminPublishSnapshot", {}, true);
      if(!r3.ok) throw new Error(r3.error || "Publish failed");

      // Final success message
      showMsg(msg, "Imported FINISHES + Stats updated + Published ‚úÖ", false);

      // üîî Check for unavoidable rematch
      try {
        const warn = await apiCall("adminGetSwissRematchWarning", {}, true);
        if (warn.ok && warn.data?.warning) {
          msg.innerHTML += "<br>‚ö†Ô∏è Rematch unavoidable in this round (same record bucket).";
          msg.style.display = "";
        }
      } catch (warnErr) {
        console.warn("Rematch warning check failed:", warnErr);
      }

    } else if(isLineups){

      showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows). Publishing JSON‚Ä¶`, false);
      await new Promise(requestAnimationFrame);

      const r3 = await apiCall("adminPublishSnapshot", {}, true);
      if(!r3.ok) throw new Error(r3.error || "Publish failed");

      showMsg(msg, "Imported LINEUPS + Published ‚úÖ", false);

    } else {
      showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows)`, false);
    }

    refreshContext();

    } catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function importNascarQualifying(){
    const msg = document.getElementById("importMsg");
    hideMsg(msg);

    const header = document.getElementById("raceHeaderSel").value;
    const autoPub = !!document.getElementById("autoPublishAfterImport").checked;

    if(!header){ showMsg(msg, "Pick a race header.", true); return; }

    try{
      showMsg(msg, "Fetching NASCAR qualifying‚Ä¶", false);
      await new Promise(requestAnimationFrame);

      const r = await apiCall("adminImportNascarQualifying", { header }, true);
      if(!r.ok) throw new Error(r.error || "API failed");

      const rowsWritten = r?.data?.rowsWritten ?? "?";

      if(autoPub){
        showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows). Publishing JSON‚Ä¶`, false);
        await new Promise(requestAnimationFrame);

        const r3 = await apiCall("adminPublishSnapshot", {}, true);
        if(!r3.ok) throw new Error(r3.error || "Publish failed");
        showMsg(msg, "Imported LINEUPS + Published ‚úÖ", false);
      } else {
        showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows).`, false);
      }

      refreshContext();
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function importNascarResults(){
    const msg = document.getElementById("importMsg");
    hideMsg(msg);

    const header = document.getElementById("raceHeaderSel").value;
    const autoPub = !!document.getElementById("autoPublishAfterImport").checked;

    if(!header){ showMsg(msg, "Pick a race header.", true); return; }

    try{
      showMsg(msg, "Fetching NASCAR results‚Ä¶", false);
      await new Promise(requestAnimationFrame);

      const r = await apiCall("adminImportNascarResults", { header }, true);
      if(!r.ok) throw new Error(r.error || "API failed");

      const rowsWritten = r?.data?.rowsWritten ?? "?";

      // Mirror your existing finishes workflow
      showMsg(msg, `Imported ‚úÖ (${rowsWritten} rows). Updating stats‚Ä¶`, false);
      await new Promise(requestAnimationFrame);

      const r1 = await apiCall("adminCompileOverallRanks", {}, true);
      if(!r1.ok) throw new Error(r1.error || "Ranks update failed");

      showMsg(msg, "Ranks updated. Updating H2H‚Ä¶", false);
      await new Promise(requestAnimationFrame);

      const r2 = await apiCall("adminCompileHeadToHead", { scope: "ALL" }, true);
      if(!r2.ok) throw new Error(r2.error || "H2H update failed");

      if(autoPub){
        showMsg(msg, "H2H updated. Publishing JSON‚Ä¶", false);
        await new Promise(requestAnimationFrame);

        const r3 = await apiCall("adminPublishSnapshot", {}, true);
        if(!r3.ok) throw new Error(r3.error || "Publish failed");

        showMsg(msg, "Imported FINISHES + Stats updated + Published ‚úÖ", false);
      } else {
        showMsg(msg, "Imported FINISHES + Stats updated ‚úÖ", false);
      }

      // Keep your rematch warning behavior
      try {
        const warn = await apiCall("adminGetSwissRematchWarning", {}, true);
        if (warn.ok && warn.data?.warning) {
          msg.innerHTML += "<br>‚ö†Ô∏è Rematch unavoidable in this round (same record bucket).";
        }
      } catch (_) {}

      refreshContext();
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function runCompileOverallRanks(){
    const msg = document.getElementById("ranksMsg");
    hideMsg(msg);

    try{
      showMsg(msg, "Working‚Ä¶", false);
      const r = await apiCall("adminCompileOverallRanks", {}, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.message || "Updated ‚úÖ", false);
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function showWinnings(){
    const msg = document.getElementById("winningsMsg");
    hideMsg(msg);

    const t = document.getElementById("winTourneySel").value;
    try{
      showMsg(msg, "Loading‚Ä¶", false);
      const r = await apiCall("adminGetTournamentWinnings", { tournament: t }, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.text || "(no data)", false);
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  
  function showH2HPicker(){
    const box = document.getElementById("h2hPicker");
    if (box) box.style.display = "block";
  }

  function hideH2HPicker(){
    const box = document.getElementById("h2hPicker");
    if (box) box.style.display = "none";
  }

  async function compileH2HFromPicker(){
    const msg = document.getElementById("h2hMsg");
    hideMsg(msg);

    const sel = document.getElementById("h2hScope");
    const pick = sel ? String(sel.value || "ALL").trim().toUpperCase() : "ALL";

    try{
      showMsg(msg, "Compiling H2H‚Ä¶", false);

      // Single endpoint call, backend loops as needed (ALL or UPTO:N)
      const r = await apiCall("adminCompileHeadToHead", { scope: pick }, true);
      if(!r.ok) throw new Error(r.error || "API failed");

      showMsg(msg, r.data?.message || "H2H compiled ‚úÖ", false);
      hideH2HPicker();
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }


  async function publishSnapshot(){
    const msg = document.getElementById("pubMsg");
    hideMsg(msg);

    try{
      showMsg(msg, "Publishing‚Ä¶", false);
      const r = await apiCall("adminPublishSnapshot", {}, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, (r.data?.message || "Published ‚úÖ") + "\n" + (r.data?.publishedAt || ""), false);
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }

  async function resetSeason(){
    const msg = document.getElementById("resetMsg");
    hideMsg(msg);

    // optional: basic safety latch so you don‚Äôt fat-finger it
    const ok = confirm("Reset the season? This will clear tournament sheets + lineups/finishes + Main/Stats ranges.");
    if(!ok) return;

    try{
      showMsg(msg, "Resetting season‚Ä¶", false);
      const r = await apiCall("adminResetSeason", {}, true);
      if(!r.ok) throw new Error(r.error || "API failed");
      showMsg(msg, r.data?.message || "Season reset ‚úÖ", false);

      // refresh context after reset so pill/panels update
      try{ await refreshContext(); }catch(e){}
    }catch(e){
      showMsg(msg, "Error: " + (e.message || e), true);
    }
  }


  // ---------- Bootstrap ----------
  async function bootstrap(){
    syncConfigUI();
    applyConfigVisibility(false);

    // ‚úÖ restore last panel (default = Numbers)
    const last = (localStorage.getItem(LS_ADMIN_PANEL) || "Numbers").trim();
    showPanel(last);
    if(!hasAdminConfig()) return;

    await refreshContext();
    await loadRaceHeadersForSheet();
    await loadPlayers();
  }

  // Init
  document.addEventListener("DOMContentLoaded", bootstrap);
</script>
</body>
</html>
