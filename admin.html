<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NASCAR Pool Admin</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 14px; max-width: 560px; margin: 0 auto; background:#f6f7f9; }
    h2 { margin: 0 0 6px 0; }
    .sub { color:#666; font-size:12px; margin-bottom:12px; }
    .card { background:#fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 14px; margin: 12px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    label { display:block; font-size: 13px; margin: 10px 0 6px; color:#111; }
    select, button, input { width: 100%; font-size: 16px; padding: 12px; border-radius: 12px; }
    select, input { border: 1px solid #cbd5e1; background: #fff; }
    button { border: 0; margin-top: 10px; background: #111; color: #fff; font-weight: 700; cursor:pointer; }
    button.secondary { background: #334155; }
    button.warn { background: #7f1d1d; }
    button:disabled { opacity: 0.55; cursor:not-allowed; }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 240px; }

    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:700; }
    .status { margin-top: 10px; font-size: 14px; white-space: pre-wrap; }

    .tiny { font-size:12px; color:#6b7280; margin-top:8px; }
    .ok { color:#166534; font-weight:700; }
    .bad { color:#991b1b; font-weight:700; }
  </style>
</head>

<body>
  <h2>NASCAR Pool Admin</h2>
  <div class="sub">
    <span id="currentPill" class="pill">Detecting current raceâ€¦</span>
  </div>

  <div class="card">
    <label for="adminKey">Admin key</label>
    <input id="adminKey" type="password" placeholder="Paste your ADMIN_KEY" />
    <div class="tiny">
      Stored locally in your browser. If youâ€™re on a government computer, maybe donâ€™t leave the keys under the doormat.
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label for="tournament">Tournament</label>
        <select id="tournament"></select>
      </div>
      <div>
        <label for="race">Race</label>
        <select id="race">
          <option value="">Select a tournament first</option>
        </select>
      </div>
    </div>

    <button class="secondary" id="refreshCtxBtn" onclick="detectCurrentContext()">ðŸ”„ Refresh Current Race</button>

    <button id="exportBtn" onclick="exportMatchups()">Export Matchups (updates Public sheet)</button>
    <button id="assignRaceBtn" onclick="assignNumbersRace()">Assign Numbers (Selected Race)</button>
    <button class="warn" id="assignAllBtn" onclick="assignNumbersAll()">Assign Numbers (ALL 4 Races)</button>

    <div id="status" class="status"></div>
  </div>

  <script>
    // === YOUR APPS SCRIPT WEB APP /exec URL ===
    const API_BASE = "https://script.google.com/macros/s/AKfycbw9ZWpslxculbHs3kwNWSBx9jU_QZx2PpLsWpa4N8DPK8qypXQObwfG5Vw_lh5lEizjuA/exec";

    // OPTIONAL: prefill (you can leave blank)
    const PREFILL_KEY = "032712";

    const statusEl = document.getElementById("status");
    const currentPill = document.getElementById("currentPill");

    const tSel = document.getElementById("tournament");
    const rSel = document.getElementById("race");
    const keyInput = document.getElementById("adminKey");

    const btns = [
      document.getElementById("refreshCtxBtn"),
      document.getElementById("exportBtn"),
      document.getElementById("assignRaceBtn"),
      document.getElementById("assignAllBtn"),
    ];

    const LS_KEY = "nascar_admin_key";

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setBusy(isBusy) { btns.forEach(b => b.disabled = !!isBusy); }

    function getKey() {
      const k = String(keyInput.value || "").trim();
      if (k) return k;
      const saved = String(localStorage.getItem(LS_KEY) || "").trim();
      return saved;
    }
    function saveKey(k) {
      localStorage.setItem(LS_KEY, String(k || "").trim());
    }

    // ---------- JSONP API helper ----------
    function apiCall(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = "__jsonp_cb_" + Math.random().toString(36).slice(2);
        const qs = new URLSearchParams({ action, callback: cbName, ...params });

        const script = document.createElement("script");
        script.src = API_BASE + "?" + qs.toString();
        script.async = true;

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("API timeout"));
        }, 12000);

        function cleanup() {
          clearTimeout(timeout);
          if (script && script.parentNode) script.parentNode.removeChild(script);
          try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
        }

        window[cbName] = (payload) => {
          cleanup();
          if (!payload || payload.ok !== true) {
            reject(new Error(payload && payload.error ? payload.error : "API error"));
            return;
          }
          resolve(payload.data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("API load failed"));
        };

        document.head.appendChild(script);
      });
    }

    // ---------- UI ----------
    function init() {
      // tournaments
      for (let i = 1; i <= 9; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = "Tournament " + i;
        tSel.appendChild(opt);
      }

      // key: prefill from localStorage, else optional constant
      const saved = String(localStorage.getItem(LS_KEY) || "").trim();
      if (saved) keyInput.value = saved;
      else if (PREFILL_KEY && PREFILL_KEY !== "PUT_YOUR_ADMIN_KEY_HERE") keyInput.value = PREFILL_KEY;

      keyInput.addEventListener("change", () => {
        const k = String(keyInput.value || "").trim();
        if (k) saveKey(k);
      });

      tSel.addEventListener("change", () => loadRaces());

      detectCurrentContext();
    }

    async function detectCurrentContext() {
      const key = getKey();
      if (!key) {
        currentPill.textContent = "Current: (enter admin key)";
        setStatus("Enter your admin key first.");
        return;
      }

      setBusy(true);
      setStatus("Detecting current raceâ€¦");

      try {
        const ctx = await apiCall("adminGetCurrentContext", { key });

        const label = (ctx && ctx.raceLabel) ? ctx.raceLabel : "(unknown)";
        currentPill.textContent = `Current: Tournament ${ctx.tournament} Â· ${label} Â· Round ${ctx.round}`;

        tSel.value = String(ctx.tournament);
        await loadRaces(true);

        if (ctx.raceLabel) rSel.value = ctx.raceLabel;

        setStatus("");
      } catch (err) {
        currentPill.textContent = "Current: (could not detect)";
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    async function loadRaces(silent) {
      const key = getKey();
      if (!key) {
        if (!silent) setStatus("Enter your admin key first.");
        return;
      }

      if (!silent) setStatus("Loading racesâ€¦");
      rSel.innerHTML = `<option value="">Select race...</option>`;

      try {
        const headers = await apiCall("adminGetTournamentRaceHeaders", {
          key,
          tournament: String(tSel.value || "")
        });

        (headers || []).forEach(h => {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = h;
          rSel.appendChild(opt);
        });

        if (!silent) setStatus("");
      } catch (err) {
        if (!silent) setStatus("Error: " + (err && err.message ? err.message : err));
      }
    }

    async function exportMatchups() {
      const key = getKey();
      if (!key) return setStatus("Enter your admin key first.");
      const t = String(tSel.value || "").trim();
      const race = String(rSel.value || "").trim();
      if (!race) return setStatus("Pick a race first.");

      setBusy(true);
      setStatus("Exporting matchups & updating Public sheetâ€¦");

      try {
        const res = await apiCall("adminExportMatchups", { key, tournament: t, race });
        setStatus((res && res.message) ? res.message : "Done.");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    async function assignNumbersRace() {
      const key = getKey();
      if (!key) return setStatus("Enter your admin key first.");
      const t = String(tSel.value || "").trim();
      const race = String(rSel.value || "").trim();
      if (!race) return setStatus("Pick a race first.");

      setBusy(true);
      setStatus("Assigning numbers (selected race)â€¦");

      try {
        const res = await apiCall("adminAssignNumbersForRace", { key, tournament: t, race });
        setStatus((res && res.message) ? res.message : "Done.");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    async function assignNumbersAll() {
      const key = getKey();
      if (!key) return setStatus("Enter your admin key first.");
      const t = String(tSel.value || "").trim();

      const ok = confirm(`Assign ALL four race number blocks for Tournament ${t}?\n\nThis overwrites F/J/N/R number ranges.`);
      if (!ok) return;

      setBusy(true);
      setStatus("Assigning numbers for ALL racesâ€¦");

      try {
        const res = await apiCall("adminAssignNumbersAllRaces", { key, tournament: t });
        setStatus((res && res.message) ? res.message : "Done.");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    init();
  </script>
</body>
</html>
