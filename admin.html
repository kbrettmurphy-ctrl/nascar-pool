<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 14px; max-width: 560px; margin: 0 auto; background:#f6f7f9; }
    h2 { margin: 0 0 6px 0; }
    .sub { color:#666; font-size:12px; margin-bottom:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .card { background:#fff; border: 1px solid #e5e7eb; border-radius: 16px; padding: 14px; margin: 12px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    label { display:block; font-size: 13px; margin: 10px 0 6px; color:#111; }
    select, button { width: 100%; font-size: 16px; padding: 12px; border-radius: 12px; }
    select { border: 1px solid #cbd5e1; background: #fff; }
    button { border: 0; margin-top: 10px; background: #111; color: #fff; font-weight: 700; cursor:pointer; }
    button.secondary { background: #334155; }
    button.warn { background: #7f1d1d; }
    button:disabled { opacity: 0.55; cursor:not-allowed; }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > div { flex:1 1 240px; }

    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:700; }
    .status { margin-top: 10px; font-size: 14px; white-space: pre-wrap; }

    .keyRow { display:flex; gap:8px; align-items:center; }
    .keyRow button { width:auto; padding:10px 12px; border-radius:12px; margin-top:0; }
    .mini { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <h2>NASCAR Pool Admin</h2>

  <div class="sub">
    <span id="currentPill" class="pill">Detecting current raceâ€¦</span>
    <span class="mini" id="keyHint"></span>
  </div>

  <div class="card">
    <div class="keyRow">
      <button class="secondary" onclick="setAdminKey(true)">ðŸ”‘ Set / Change Key</button>
      <button class="secondary" onclick="clearAdminKey()">ðŸ§¹ Clear Key</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label for="tournament">Tournament</label>
        <select id="tournament"></select>
      </div>
      <div>
        <label for="race">Race</label>
        <select id="race">
          <option value="">Select a tournament first</option>
        </select>
      </div>
    </div>

    <button class="secondary" id="refreshCtxBtn" onclick="detectCurrentContext()">ðŸ”„ Refresh Current Race</button>

    <button id="assignRaceBtn" onclick="assignNumbersRace()">Assign Numbers (Selected Race)</button>
    <button class="warn" id="assignAllBtn" onclick="assignNumbersAll()">Assign Numbers (ALL 4 Races)</button>

    <div id="status" class="status"></div>
  </div>

  <script>
    // Your Apps Script Web App endpoint
    const API_URL = "https://script.google.com/macros/s/AKfycbw9ZWpslxculbHs3kwNWSBx9jU_QZx2PpLsWpa4N8DPK8qypXQObwfG5Vw_lh5lEizjuA/exec";

    // Where we store the key on this device/browser
    const ADMIN_KEY_STORAGE = "nascar_admin_key";

    // JSONP helper (CORS-proof)
    function apiCall(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cbName = "__nascar_admin_cb_" + Math.random().toString(36).slice(2);
        const q = new URLSearchParams({ action, ...params, callback: cbName });

        const script = document.createElement("script");
        script.src = API_URL + (API_URL.includes("?") ? "&" : "?") + q.toString();

        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("API timeout."));
        }, 12000);

        function cleanup() {
          clearTimeout(timeout);
          if (window[cbName]) delete window[cbName];
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (payload) => {
          cleanup();
          if (!payload || payload.ok !== true) {
            reject(new Error((payload && payload.error) ? payload.error : "API error"));
            return;
          }
          resolve(payload.data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error("API load failed."));
        };

        document.body.appendChild(script);
      });
    }

    // UI refs
    const statusEl = document.getElementById("status");
    const currentPill = document.getElementById("currentPill");
    const keyHint = document.getElementById("keyHint");
    const tSel = document.getElementById("tournament");
    const rSel = document.getElementById("race");

    const btns = [
      document.getElementById("refreshCtxBtn"),
      document.getElementById("assignRaceBtn"),
      document.getElementById("assignAllBtn"),
    ];

    function setStatus(msg) { statusEl.textContent = msg || ""; }
    function setBusy(isBusy) { btns.forEach(b => b.disabled = !!isBusy); }

    function getAdminKey() {
      return String(localStorage.getItem(ADMIN_KEY_STORAGE) || "").trim();
    }

    function showKeyHint() {
      const k = getAdminKey();
      keyHint.textContent = k ? "Key saved âœ…" : "No key saved";
    }

    function setAdminKey(forcePrompt = false) {
      const current = getAdminKey();
      if (current && !forcePrompt) return current;

      const entered = prompt("Enter admin key:", current || "");
      if (entered == null) return ""; // cancelled
      const k = String(entered).trim();
      if (!k) {
        alert("Key can't be blank.");
        return "";
      }
      localStorage.setItem(ADMIN_KEY_STORAGE, k);
      showKeyHint();
      return k;
    }

    function clearAdminKey() {
      localStorage.removeItem(ADMIN_KEY_STORAGE);
      showKeyHint();
      setStatus("Admin key cleared on this device.");
    }

    function requireKeyOrStop() {
      let k = getAdminKey();
      if (!k) k = setAdminKey(true);
      if (!k) {
        setStatus("No admin key set. Can't run admin actions.");
        return "";
      }
      return k;
    }

    function init() {
      for (let i = 1; i <= 9; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = "Tournament " + i;
        tSel.appendChild(opt);
      }

      showKeyHint();
      detectCurrentContext();
      tSel.addEventListener("change", loadRaces);
    }

    async function detectCurrentContext() {
      const key = requireKeyOrStop();
      if (!key) return;

      setBusy(true);
      setStatus("Detecting current raceâ€¦");

      try {
        const ctx = await apiCall("adminGetCurrentContext", { key });
        const label = (ctx && ctx.raceLabel) ? ctx.raceLabel : "(unknown)";
        currentPill.textContent = `Current: Tournament ${ctx.tournament} Â· ${label} Â· Round ${ctx.round}`;

        tSel.value = String(ctx.tournament);
        await loadRaces();
        if (ctx.raceLabel) rSel.value = ctx.raceLabel;

        setStatus("");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
        currentPill.textContent = "Current: (could not detect)";
      } finally {
        setBusy(false);
      }
    }

    async function loadRaces() {
      const key = requireKeyOrStop();
      if (!key) return;

      setStatus("Loading racesâ€¦");
      rSel.innerHTML = `<option value="">Select race...</option>`;

      try {
        const headers = await apiCall("adminGetTournamentRaceHeaders", { key, tournament: tSel.value });
        (headers || []).forEach(h => {
          const opt = document.createElement("option");
          opt.value = h;
          opt.textContent = h;
          rSel.appendChild(opt);
        });
        setStatus("");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      }
    }

    async function assignNumbersRace() {
      const key = requireKeyOrStop();
      if (!key) return;

      const race = rSel.value;
      if (!race) return setStatus("Pick a race first.");

      setBusy(true);
      setStatus("Assigning numbers (selected race)â€¦");

      try {
        const res = await apiCall("adminAssignNumbersForRace", { key, tournament: tSel.value, race });
        setStatus(res && res.message ? res.message : "Done.");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    async function assignNumbersAll() {
      const key = requireKeyOrStop();
      if (!key) return;

      const t = tSel.value;
      const ok = confirm(`Assign ALL four race number blocks for Tournament ${t}?\n\nThis overwrites F/J/N/R number ranges.`);
      if (!ok) return;

      setBusy(true);
      setStatus("Assigning numbers for ALL racesâ€¦");

      try {
        const res = await apiCall("adminAssignNumbersAllRaces", { key, tournament: t });
        setStatus(res && res.message ? res.message : "Done.");
      } catch (err) {
        setStatus("Error: " + (err && err.message ? err.message : err));
      } finally {
        setBusy(false);
      }
    }

    init();
  </script>
</body>
</html>
