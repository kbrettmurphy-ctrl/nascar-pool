<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NASCAR Pool Admin</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#666; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--text); font-family: Arial, sans-serif; }
    body{ padding:14px; max-width: 760px; margin:0 auto; }
    h2{ margin: 0 0 6px 0; }
    .sub{ color:var(--muted); font-size:12px; margin-bottom:12px; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    label{ display:block; font-size:13px; margin:10px 0 6px; }
    select, input, textarea, button{
      width:100%;
      font-size:16px;
      padding:12px;
      border-radius:12px;
      box-sizing:border-box;
    }
    select,input,textarea{ border:1px solid #cbd5e1; background:#fff; }
    textarea{ min-height:140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    button{ border:0; margin-top:10px; background:#111; color:#fff; font-weight:800; cursor:pointer; }
    button.secondary{ background:#334155; }
    button.warn{ background:#7f1d1d; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > div{ flex:1 1 240px; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; font-weight:800; }
    .status{ margin-top:10px; font-size:14px; white-space:pre-wrap; }
    .tiny{ font-size:12px; color:var(--muted); margin-top:6px; }
    .divider{ height:1px; background:var(--border); margin:14px 0; }
    .right{ text-align:right; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; padding:2px 6px; border:1px solid var(--border); border-radius:8px; background:#fff; }
  </style>
</head>
<body>
  <h2>NASCAR Pool Admin</h2>
  <div class="sub">
    <span id="currentPill" class="pill">Detecting current race‚Ä¶</span>
  </div>

  <!-- CONFIG -->
  <div class="card">
    <div class="row">
      <div>
        <label>API Base (GAS /exec)</label>
        <input id="apiBase" placeholder="https://script.google.com/macros/s/.../exec" />
        <div class="tiny">This is your deployed Web App URL (ends with <span class="kbd">/exec</span>).</div>
      </div>
      <div>
        <label>Admin Key</label>
        <input id="adminKey" placeholder="ADMIN_KEY (stored locally)" />
        <div class="tiny">Stored in this browser only (localStorage).</div>
      </div>
    </div>
    <button class="secondary" onclick="saveConfig()">Save Config</button>
    <div id="configStatus" class="status"></div>
  </div>

  <!-- CORE CONTEXT / NUMBERS -->
  <div class="card">
    <div class="row">
      <div>
        <label for="tournament">Tournament</label>
        <select id="tournament"></select>
      </div>
      <div>
        <label for="race">Race</label>
        <select id="race"><option value="">Select a tournament first</option></select>
      </div>
    </div>

    <button class="secondary" id="refreshCtxBtn" onclick="detectCurrentContext()">üîÑ Refresh Current Race</button>
    <button id="assignRaceBtn" onclick="assignNumbersRace()">Assign Numbers (Selected Race)</button>
    <button class="warn" id="assignAllBtn" onclick="assignNumbersAll()">Assign Numbers (ALL 4 Races)</button>

    <div id="status" class="status"></div>
  </div>

  <!-- ADD FUNDS -->
  <div class="card">
    <div style="font-weight:900;font-size:18px;">Add Funds</div>
    <div class="row">
      <div>
        <label for="fundsPlayer">Player</label>
        <select id="fundsPlayer"><option value="">Loading‚Ä¶</option></select>
      </div>
      <div>
        <label for="fundsAmount">Amount</label>
        <input id="fundsAmount" placeholder="25 or 25.00" inputmode="decimal" />
      </div>
    </div>
    <button onclick="addFunds()">Add Funds</button>
    <div id="fundsStatus" class="status"></div>
  </div>

  <!-- PASTE IMPORT -->
  <div class="card">
    <div style="font-weight:900;font-size:18px;">Paste Starting Lineups / Finishes</div>

    <label for="pasteSheetType">Which sheet?</label>
    <select id="pasteSheetType" onchange="loadPasteHeaders()">
      <option value="starting">Starting Lineups</option>
      <option value="finishes">Finishes</option>
    </select>

    <label for="pasteHeader">Race Header</label>
    <select id="pasteHeader"></select>

    <label for="pasteText">Paste the table block</label>
    <textarea id="pasteText" placeholder="Paste from Wikipedia (or wherever) here‚Ä¶"></textarea>
    <div class="tiny">We‚Äôll strip junk like ‚Äú(R)‚Äù and ‚Äú(i)‚Äù and match against your Drivers tab when possible.</div>

    <button onclick="importPaste()">Import Paste</button>
    <div id="pasteStatus" class="status"></div>
  </div>

  <!-- RANKS / STATS REFRESH -->
  <div class="card">
    <div style="font-weight:900;font-size:18px;">Refresh Overall Rankings</div>
    <div class="tiny">This runs your restored <span class="kbd">compileOverallRanks()</span> so the Stats page updates.</div>
    <button onclick="runOverallRanks()">Run CompileOverallRanks</button>
    <div id="ranksStatus" class="status"></div>
  </div>

  <!-- TOURNAMENT WINNINGS -->
  <div class="card">
    <div style="font-weight:900;font-size:18px;">Tournament Winnings</div>
    <div class="row">
      <div>
        <label for="winTournament">Tournament</label>
        <select id="winTournament"></select>
      </div>
      <div class="right" style="align-self:flex-end;">
        <button class="secondary" style="margin-top:0;" onclick="loadWinnings()">Show Winnings</button>
      </div>
    </div>
    <div id="winBox" class="status"></div>
  </div>

<script>
  // ====== STATE / UI ======
  const statusEl = document.getElementById("status");
  const currentPill = document.getElementById("currentPill");
  const tSel = document.getElementById("tournament");
  const rSel = document.getElementById("race");

  const btns = [
    document.getElementById("refreshCtxBtn"),
    document.getElementById("assignRaceBtn"),
    document.getElementById("assignAllBtn"),
  ];

  function setStatus(msg){ statusEl.textContent = msg || ""; }
  function setBusy(isBusy){ btns.forEach(b => b.disabled = !!isBusy); }

  function getApiBase(){
    return (document.getElementById("apiBase").value || "").trim();
  }
  function getAdminKey(){
    return (document.getElementById("adminKey").value || "").trim();
  }

  function saveConfig(){
    const base = getApiBase();
    const key = getAdminKey();
    localStorage.setItem("nascar_api_base", base);
    localStorage.setItem("nascar_admin_key", key);
    document.getElementById("configStatus").textContent = "Saved.";
  }

  function loadConfig(){
    const base = localStorage.getItem("nascar_api_base") || "";
    const key = localStorage.getItem("nascar_admin_key") || "";
    document.getElementById("apiBase").value = base;
    document.getElementById("adminKey").value = key;
  }

  // ====== API CALL ======
  async function apiCall(action, params = {}, isAdmin = false){
    const base = getApiBase();
    if(!base) throw new Error("Missing API Base URL.");

    const u = new URL(base);
    u.searchParams.set("action", action);

    if(isAdmin){
      const key = getAdminKey();
      if(!key) throw new Error("Missing Admin Key.");
      u.searchParams.set("key", key);
    }

    Object.keys(params || {}).forEach(k => {
      if(params[k] !== undefined && params[k] !== null){
        u.searchParams.set(k, String(params[k]));
      }
    });

    const res = await fetch(u.toString(), { method:"GET", cache:"no-store" });
    const json = await res.json();
    return json;
  }

  // ====== INIT ======
  function init(){
    loadConfig();

    for(let i=1;i<=9;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = "Tournament " + i;
      tSel.appendChild(opt);

      const opt2 = document.createElement("option");
      opt2.value = String(i);
      opt2.textContent = "Tournament " + i;
      document.getElementById("winTournament").appendChild(opt2);
    }

    tSel.addEventListener("change", loadRaces);

    detectCurrentContext();
    loadPlayersForFunds();
    loadPasteHeaders();
  }

  // ====== CONTEXT / RACES / NUMBERS ======
  async function detectCurrentContext(){
    setBusy(true);
    setStatus("Detecting current race‚Ä¶");

    try{
      const ctxRes = await apiCall("adminGetCurrentContext", {}, true);
      if(!ctxRes.ok) throw new Error(ctxRes.error || "API failed");

      const ctx = ctxRes.data || {};
      const label = ctx.raceLabel ? ctx.raceLabel : "(unknown)";
      currentPill.textContent = `Current: Tournament ${ctx.tournament} ¬∑ ${label} ¬∑ Round ${ctx.round}`;

      tSel.value = String(ctx.tournament);
      await loadRaces();
      if(ctx.raceLabel) rSel.value = ctx.raceLabel;

      setStatus("");
    }catch(e){
      currentPill.textContent = "Current: (could not detect)";
      setStatus("Error: " + (e && e.message ? e.message : e));
    }finally{
      setBusy(false);
    }
  }

  async function loadRaces(){
    setStatus("Loading races‚Ä¶");
    rSel.innerHTML = `<option value="">Select race...</option>`;

    try{
      const res = await apiCall("adminGetTournamentRaceHeaders", { tournament: tSel.value }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      (res.data || []).forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        rSel.appendChild(opt);
      });
      setStatus("");
    }catch(e){
      setStatus("Error: " + (e && e.message ? e.message : e));
    }
  }

  async function assignNumbersRace(){
    const race = rSel.value;
    if(!race) return setStatus("Pick a race first.");

    setBusy(true);
    setStatus("Assigning numbers (selected race)‚Ä¶");

    try{
      const res = await apiCall("adminAssignNumbersForRace", { tournament: tSel.value, race }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      setStatus(res.data?.message || "Done.");
    }catch(e){
      setStatus("Error: " + (e && e.message ? e.message : e));
    }finally{
      setBusy(false);
    }
  }

  async function assignNumbersAll(){
    const t = tSel.value;
    const ok = confirm(`Assign ALL four race number blocks for Tournament ${t}?\n\nThis overwrites F/J/N/R number ranges.`);
    if(!ok) return;

    setBusy(true);
    setStatus("Assigning numbers for ALL races‚Ä¶");

    try{
      const res = await apiCall("adminAssignNumbersAllRaces", { tournament: t }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      setStatus(res.data?.message || "Done.");
    }catch(e){
      setStatus("Error: " + (e && e.message ? e.message : e));
    }finally{
      setBusy(false);
    }
  }

  // ====== ADD FUNDS ======
  async function loadPlayersForFunds(){
    const sel = document.getElementById("fundsPlayer");
    sel.innerHTML = `<option value="">Loading‚Ä¶</option>`;
    try{
      const res = await apiCall("adminGetMainPlayerList", {}, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      const list = res.data || [];
      sel.innerHTML = `<option value="">Select‚Ä¶</option>`;
      list.forEach(n => {
        const opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
    }catch(e){
      document.getElementById("fundsStatus").textContent = "Error: " + (e && e.message ? e.message : e);
      sel.innerHTML = `<option value="">(error)</option>`;
    }
  }

  async function addFunds(){
    const player = document.getElementById("fundsPlayer").value;
    const amt = document.getElementById("fundsAmount").value.trim();
    const out = document.getElementById("fundsStatus");
    out.textContent = "Saving‚Ä¶";
    try{
      if(!player) throw new Error("Pick a player.");
      if(!amt) throw new Error("Enter an amount.");
      const res = await apiCall("adminAddFunds", { player, amount: amt }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      out.textContent = res.data?.message || "Saved.";
      document.getElementById("fundsAmount").value = "";
    }catch(e){
      out.textContent = "Error: " + (e && e.message ? e.message : e);
    }
  }

  // ====== PASTE IMPORT ======
  async function loadPasteHeaders(){
    const sheetType = document.getElementById("pasteSheetType").value;
    const headerSel = document.getElementById("pasteHeader");
    const out = document.getElementById("pasteStatus");
    out.textContent = "";
    headerSel.innerHTML = `<option value="">Loading‚Ä¶</option>`;

    try{
      const res = await apiCall("adminGetRaceHeaders", { sheetType }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      const headers = res.data || [];
      headerSel.innerHTML = `<option value="">Select race header‚Ä¶</option>`;
      headers.forEach(h => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        headerSel.appendChild(opt);
      });
    }catch(e){
      headerSel.innerHTML = `<option value="">(error)</option>`;
      out.textContent = "Error: " + (e && e.message ? e.message : e);
    }
  }

  async function importPaste(){
    const sheetType = document.getElementById("pasteSheetType").value;
    const header = document.getElementById("pasteHeader").value;
    const rawText = document.getElementById("pasteText").value || "";
    const out = document.getElementById("pasteStatus");
    out.textContent = "Importing‚Ä¶";

    try{
      if(!header) throw new Error("Pick a race header.");
      if(!rawText.trim()) throw new Error("Paste the list first.");

      const res = await apiCall("adminImportPastedList", { sheetType, header, rawText }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      out.textContent = res.data?.message || "Imported.";
      document.getElementById("pasteText").value = "";
    }catch(e){
      out.textContent = "Error: " + (e && e.message ? e.message : e);
    }
  }

  // ====== COMPILE OVERALL RANKS ======
  async function runOverallRanks(){
    const out = document.getElementById("ranksStatus");
    out.textContent = "Running‚Ä¶";
    try{
      const res = await apiCall("adminRunCompileOverallRanks", {}, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      out.textContent = res.data?.message || "Done.";
    }catch(e){
      out.textContent = "Error: " + (e && e.message ? e.message : e);
    }
  }

  // ====== TOURNAMENT WINNINGS ======
  async function loadWinnings(){
    const t = document.getElementById("winTournament").value;
    const box = document.getElementById("winBox");
    box.textContent = "Loading‚Ä¶";
    try{
      const res = await apiCall("adminGetTournamentWinnings", { tournament: t }, true);
      if(!res.ok) throw new Error(res.error || "API failed");
      box.textContent = res.data?.text || "(no data)";
    }catch(e){
      box.textContent = "Error: " + (e && e.message ? e.message : e);
    }
  }

  init();
</script>
</body>
</html>
